<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolitas Interactivas - P4B</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            background-color: #f4f4f9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
            transition: background-color 2s ease; 
        }

        /* Panel lateral fijo a la izquierda */
        .sidebar {
            width: 200px; 
            min-width: 200px;
            background-color: #ffe6f2;
            border: 8px ridge #C0C0C0; 
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 20px 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            transition: background-color 2s ease, border-color 1s ease; 
        }

        /* Contenedor del lienzo de dibujo */
        #canvas-container {
            flex: 1; 
            border: 16px ridge #CD7F32; 
            border-radius: 20px;
            background-color: #fff0f5;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            transition: border-color 1s ease, background-color 2s ease; 
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        h3 {
            margin: 0 0 10px 0; 
            color: #00008B; 
            font-size: 14px; 
            text-align: center;
            text-transform: uppercase;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
        }

        .franjas-section {
            margin-top: auto; 
            padding-top: 20px;
            border-top: 3px dashed #ffb3d9;
        }

        /* Nuevo contenedor para los botones verticales */
        .contenedor-franjas {
            display: flex;
            flex-direction: row;
            justify-content: center; /* Centra los botones m√°s finos */
            gap: 20px; /* Un poco m√°s de separaci√≥n al ser m√°s finos */
            height: 200px; /* M√°s cortos (antes 280px) */
            width: 100%;
        }

        /* Botones de grupos */
        .grupo-botones {
            display: flex;
            flex-direction: column;
            gap: 6px; 
        }

        .grupo-botones button {
            background-color: #fff;
            border: 2px solid #ff99cc;
            color: #00008B; 
            padding: 6px; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px; 
        }

        .grupo-botones button:hover {
            background-color: #ffe6f2;
        }

        .grupo-botones button.activo {
            background-color: #ff66b2;
            color: #fff;
            border-color: #ff3399;
        }

        /* Botones Franjas */
        .btn-zona {
            width: 65px; /* Ligeramente m√°s ancho para que quepan dos columnas de texto */
            padding: 5px 0;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px; 
            color: #fff; 
            border: 2px solid;
            
            /* Propiedades para texto vertical */
            writing-mode: vertical-lr; /* Cambiado de rl a lr (left-to-right) para que "L√çNEA" quede a la izquierda */
            text-orientation: upright;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4); 
        }
        
        /* Botones rellenos de color con sus estados */
        #btn-zona-amarilla { 
            background-color: #d4a000; 
            border-color: #b38600; 
        }
        #btn-zona-amarilla:hover { background-color: #eeb300; }
        #btn-zona-amarilla.activo { 
            background-color: #a67c00; 
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.4); /* Efecto de hundido al activarlo */
            border-color: #806000;
        }
        
        #btn-zona-roja { 
            background-color: #dc3545; 
            border-color: #b02a37; 
        }
        #btn-zona-roja:hover { background-color: #e55363; }
        #btn-zona-roja.activo { 
            background-color: #b02a37; 
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.4); /* Efecto de hundido al activarlo */
            border-color: #842029;
        }

        /* Cuadr√≠cula 2x2 para los botones de grupos */
        .grid-grupos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px; 
        }

        /* Bot√≥n Reiniciar */
        #btn-reiniciar {
            background-color: #ffeb3b; /* Amarillo */
            color: #00008B;
            border-color: #d4a000;
        }
        #btn-reiniciar:hover {
            background-color: #fbc02d;
        }

        /* Bot√≥n Stop Especial */
        #btn-stop {
            background-color: #ff3333;
            color: white;
            border-color: #cc0000;
            margin-top: 2px; 
            font-size: 13px; 
            padding: 8px;
        }
        #btn-stop:hover { background-color: #ff6666; }
        #btn-stop.activo-stop {
            background-color: #28a745;
            border-color: #1e7e34;
        }
        #btn-stop.activo-stop:hover { background-color: #34ce57; }

        .btn-separador {
            margin-top: 2px;
            border-top: 2px dashed #ffb3d9;
            padding-top: 8px;
        }

        .titulo {
            position: absolute;
            top: 20px;
            left: 20px; 
            color: #ff3399;
            font-size: 28px;
            font-weight: bold;
            text-align: left;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            pointer-events: none;
            z-index: 10;
        }

        .subtitulo {
            font-size: 15px;
            color: #666;
            display: block;
            font-weight: normal;
            text-shadow: none;
            margin-top: 5px;
        }

        /* Bot√≥n flotante para la ficha */
        #btn-abrir-ficha {
            display: none;
            position: absolute;
            background: #ff66b2;
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
            transition: transform 0.2s;
        }
        #btn-abrir-ficha:hover { transform: scale(1.05); }

        /* Modal Ficha */
        #modal-ficha {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        #modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 5px solid #ff66b2;
        }

        #modal-content h2 { margin: 0; color: #ff3399; }
        
        #ficha-texto {
            width: 100%;
            height: 150px;
            resize: none;
            padding: 10px;
            border: 2px solid #ffb3d9;
            border-radius: 8px;
            font-family: inherit;
            box-sizing: border-box;
            font-size: 14px;
        }

        .close-btn {
            align-self: flex-end;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            margin-top: -10px;
            margin-bottom: -15px;
        }
        .close-btn:hover { color: #ff3399; }
    </style>
</head>
<body>

    <!-- Panel Lateral Izquierdo -->
    <aside class="sidebar" id="panel-sidebar">
        
        <div class="sidebar-section">
            <h3>FORMA GRUPOS</h3>
            <div class="grupo-botones">
                <div class="grid-grupos">
                    <button id="btn-1" class="activo" onclick="setGrupo(1)">De 1</button>
                    <button id="btn-2" onclick="setGrupo(2)">De 2</button>
                    <button id="btn-3" onclick="setGrupo(3)">De 3</button>
                    <button id="btn-4" onclick="setGrupo(4)">De 4</button>
                </div>
                <div class="btn-separador" style="border-top:none; padding-top:4px;"></div>
                <button id="btn-reiniciar" onclick="reiniciarBolas()">üîÑ Soltar y Reiniciar</button>
                <button id="btn-stop" onclick="toggleStop()">‚è∏Ô∏è STOP</button>
            </div>
        </div>

        <div class="sidebar-section franjas-section">
            <h3>FRANJAS</h3>
            <div class="contenedor-franjas">
                <button id="btn-zona-amarilla" class="btn-zona" onclick="toggleZona('amarilla')">L√çNEA<br>AMARILLA</button>
                <button id="btn-zona-roja" class="btn-zona" onclick="toggleZona('roja')">L√çNEA<br>ROJA</button>
            </div>
        </div>
        
    </aside>

    <!-- √Årea del Canvas Derecho -->
    <main id="canvas-container">
        <!-- T√≠tulos Superiores -->
        <div class="titulo">
            <span id="nombre-clase-titulo">4¬∫B</span>
            <span class="subtitulo" id="subtitulo-clase">Haz clic en una bolita para verla en grande</span>
        </div>

        <!-- Bot√≥n flotante Ficha -->
        <button id="btn-abrir-ficha" onclick="abrirFicha()">üìù Abrir Ficha</button>

        <!-- Modal emergente Ficha -->
        <div id="modal-ficha">
            <div id="modal-content">
                <span class="close-btn" onclick="cerrarFicha()">&times;</span>
                <h2 id="ficha-titulo">Ficha</h2>
                <textarea id="ficha-texto" placeholder="A√±ade notas aqu√≠..."></textarea>
            </div>
        </div>

        <canvas id="miCanvas"></canvas>
    </main>

    <script>
        const canvas = document.getElementById('miCanvas');
        const ctx = canvas.getContext('2d');

        // Nombres extra√≠dos del documento P4B.pdf
        let nombresActuales = [
            "Enzo", "Daniel", "Nerea", "Valle", "Diana", "√Ålvaro", 
            "Catalina", "Alba", "Mauro", "Mart√≠n Jos√©", "Mateo", 
            "In√©s", "Xelaz", "Keisi", "Olivia", "Daniel", 
            "Derek", "Diego"
        ];

        let bolitas = [];
        const RADIO_BASE = 40; 
        
        let bolitaSeleccionada = null;
        let bolitaEnRetorno = null;
        let maxGrupo = 1;
        let temporizadorEstancamiento = 0; 

        // Zonas Laterales (Aparcamiento)
        const ZONA_WIDTH = 90; // Franjas estrechas
        let zonaAmarillaHabilitada = false;
        let zonaRojaHabilitada = false;

        // Variables de Arrastre y Pausa
        let isPaused = false;
        let bolitaArrastrada = null;
        let isDragging = false;
        let startX, startY;

        // Diccionario de Notas Ficha
        const notasAlumnos = {};

        function ajustarCanvas() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        window.addEventListener('resize', () => {
            ajustarCanvas();
            bolitas.forEach(b => {
                if(b.x + b.radio > canvas.width) b.x = canvas.width - b.radio - 5;
                if(b.y + b.radio > canvas.height) b.y = canvas.height - b.radio - 5;
            });
        });

        function setGrupo(num) {
            maxGrupo = num;
            temporizadorEstancamiento = 0; 
            document.querySelectorAll('.grupo-botones button').forEach(btn => btn.classList.remove('activo'));
            document.getElementById('btn-' + num).classList.add('activo');
        }

        function toggleZona(color) {
            if (color === 'amarilla') {
                zonaAmarillaHabilitada = !zonaAmarillaHabilitada;
                const btn = document.getElementById('btn-zona-amarilla');
                if (zonaAmarillaHabilitada) {
                    btn.classList.add('activo');
                    bolitas.forEach(b => {
                        // Expulsar si la zona amarilla se activa
                        if (!b.enZona && b.x - b.radio < ZONA_WIDTH) {
                            b.x = ZONA_WIDTH + b.radio;
                            b.dx = Math.abs(b.dx);
                        }
                    });
                } else {
                    btn.classList.remove('activo');
                    bolitas.forEach(b => { if (b.enZona === 'amarilla') b.enZona = false; });
                }
            } else {
                zonaRojaHabilitada = !zonaRojaHabilitada;
                const btn = document.getElementById('btn-zona-roja');
                if (zonaRojaHabilitada) {
                    btn.classList.add('activo');
                    bolitas.forEach(b => {
                        // Expulsar si la zona roja se activa
                        if (!b.enZona && b.x + b.radio > canvas.width - ZONA_WIDTH) {
                            b.x = canvas.width - ZONA_WIDTH - b.radio;
                            b.dx = -Math.abs(b.dx);
                        }
                    });
                } else {
                    btn.classList.remove('activo');
                    bolitas.forEach(b => { if (b.enZona === 'roja') b.enZona = false; });
                }
            }
        }

        function reiniciarBolas() {
            if (nombresActuales.length === 0) return;
            setGrupo(1);
            iniciar();
        }

        function toggleStop() {
            isPaused = !isPaused;
            const btn = document.getElementById('btn-stop');
            if (isPaused) {
                btn.innerHTML = '‚ñ∂Ô∏è PLAY';
                btn.classList.add('activo-stop');
                document.getElementById('subtitulo-clase').innerText = "Modo pausa: Arrastra las bolitas donde quieras";
            } else {
                btn.innerHTML = '‚è∏Ô∏è STOP';
                btn.classList.remove('activo-stop');
                document.getElementById('subtitulo-clase').innerText = "Haz clic en una bolita para verla en grande";
            }
        }

        // Gesti√≥n de la Ficha Modal
        function abrirFicha() {
            if (!bolitaSeleccionada) return;
            const nombreGrupo = bolitaSeleccionada.nombres.join(', ');
            document.getElementById('ficha-titulo').innerText = nombreGrupo;
            document.getElementById('ficha-texto').value = notasAlumnos[nombreGrupo] || '';
            document.getElementById('modal-ficha').style.display = 'flex';
        }

        function cerrarFicha() {
            const nombreGrupo = document.getElementById('ficha-titulo').innerText;
            notasAlumnos[nombreGrupo] = document.getElementById('ficha-texto').value;
            document.getElementById('modal-ficha').style.display = 'none';
        }

        function colorAleatorio() {
            const colores = [
                '#FF5733', '#33FF57', '#3357FF', '#F033FF', '#33FFF0',
                '#FFD133', '#FF3380', '#80FF33', '#3380FF', '#FF8C33',
                '#4A235A', '#117A65', '#D4AC0D', '#BA4A00', '#2E86C1'
            ];
            return colores[Math.floor(Math.random() * colores.length)];
        }

        function rotar(velocidad, angulo) {
            return {
                x: velocidad.x * Math.cos(angulo) - velocidad.y * Math.sin(angulo),
                y: velocidad.x * Math.sin(angulo) + velocidad.y * Math.cos(angulo)
            };
        }

        function resolverColision(bolita, otraBolita) {
            const diffXVelocidad = bolita.dx - otraBolita.dx;
            const diffYVelocidad = bolita.dy - otraBolita.dy;
            const xDist = otraBolita.x - bolita.x;
            const yDist = otraBolita.y - bolita.y;

            if (diffXVelocidad * xDist + diffYVelocidad * yDist >= 0) {
                const angulo = -Math.atan2(otraBolita.y - bolita.y, otraBolita.x - bolita.x);
                const m1 = bolita.masa;
                const m2 = otraBolita.masa;
                const u1 = rotar({ x: bolita.dx, y: bolita.dy }, angulo);
                const u2 = rotar({ x: otraBolita.dx, y: otraBolita.dy }, angulo);

                const v1 = { x: (u1.x * (m1 - m2) + 2 * m2 * u2.x) / (m1 + m2), y: u1.y };
                const v2 = { x: (u2.x * (m2 - m1) + 2 * m1 * u1.x) / (m1 + m2), y: u2.y };

                const vFinal1 = rotar(v1, -angulo);
                const vFinal2 = rotar(v2, -angulo);

                bolita.dx = vFinal1.x;
                bolita.dy = vFinal1.y;
                otraBolita.dx = vFinal2.x;
                otraBolita.dy = vFinal2.y;
            }
        }

        class Bolita {
            constructor(x, y, radio, color, nombresArray) {
                this.x = x;
                this.y = y;
                this.radioOriginal = radio; 
                this.radio = radio;
                this.color = color;
                
                this.nombres = nombresArray; 
                this.masa = nombresArray.length; 

                this.xOriginal = x; 
                this.yOriginal = y;
                this.marcadaParaBorrar = false;
                this.cooldownFusion = 0; 
                this.tiempoLleno = 0; 
                this.forzarFusionCon = null; 
                this.enZona = false; 
                
                // Velocidad base a√∫n m√°s reducida
                this.dx = (Math.random() - 0.5) * 1.5;
                this.dy = (Math.random() - 0.5) * 1.5;
                
                // Velocidad m√≠nima muy baja para que el movimiento sea s√∫per lento
                if (Math.abs(this.dx) < 0.4) this.dx = this.dx < 0 ? -0.5 : 0.5;
                if (Math.abs(this.dy) < 0.4) this.dy = this.dy < 0 ? -0.5 : 0.5;
            }

            dibujar(esGrande = false) {
                ctx.beginPath();
                ctx.arc(this.x + (esGrande ? 8 : 3), this.y + (esGrande ? 8 : 3), this.radio, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radio, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.lineWidth = esGrande ? 6 : 3;
                ctx.strokeStyle = '#fff';
                ctx.stroke();
                ctx.closePath();

                ctx.fillStyle = '#00008B'; 
                const fontSize = esGrande ? 38 : 16;
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.lineWidth = esGrande ? 4 : 2;
                ctx.strokeStyle = '#ffffff'; 
                
                let lineSpacing = esGrande ? (fontSize + 10) : 18;
                let startY = this.y - ((this.nombres.length - 1) * lineSpacing) / 2;
                
                this.nombres.forEach((nombre, idx) => {
                    let yPos = startY + idx * lineSpacing;
                    ctx.strokeText(nombre, this.x, yPos);
                    ctx.fillText(nombre, this.x, yPos);
                });
            }

            actualizar(bolitasArray, pausado) {
                if (this.marcadaParaBorrar) return;
                
                if (this.cooldownFusion > 0 && !pausado) this.cooldownFusion--; 

                this.dibujar();

                if (pausado) return; 

                // Muros fijos desde que pulsamos el bot√≥n de la franja
                let limiteIzquierdo = zonaAmarillaHabilitada ? ZONA_WIDTH : 0;
                let limiteDerecho = zonaRojaHabilitada ? canvas.width - ZONA_WIDTH : canvas.width;

                if (this.x - this.radio <= limiteIzquierdo) {
                    this.dx = Math.abs(this.dx);
                    this.x = limiteIzquierdo + this.radio;
                } else if (this.x + this.radio >= limiteDerecho) {
                    this.dx = -Math.abs(this.dx);
                    this.x = limiteDerecho - this.radio;
                }
                
                if (this.y + this.radio >= canvas.height || this.y - this.radio <= 0) {
                    this.dy = -this.dy;
                    if (this.y + this.radio >= canvas.height) this.y = canvas.height - this.radio;
                    if (this.y - this.radio <= 0) this.y = this.radio;
                }

                // Chocar con otras bolas
                for (let i = 0; i < bolitasArray.length; i++) {
                    let otra = bolitasArray[i];
                    if (this === otra || otra.marcadaParaBorrar || otra.enZona) continue;

                    const dist = Math.hypot(this.x - otra.x, this.y - otra.y);
                    
                    if (dist - (this.radio + otra.radio) < 0) {
                        
                        let puedeFusionarseNormal = maxGrupo > 1 && (this.nombres.length + otra.nombres.length) <= maxGrupo;
                        let esFusionForzada = (this.forzarFusionCon === otra) || (otra.forzarFusionCon === this);

                        if (this.forzarFusionCon && !esFusionForzada) puedeFusionarseNormal = false;
                        if (otra.forzarFusionCon && !esFusionForzada) puedeFusionarseNormal = false;

                        if ((puedeFusionarseNormal || esFusionForzada) && 
                            this.cooldownFusion === 0 && 
                            otra.cooldownFusion === 0) {
                            
                            const m1 = this.masa;
                            const m2 = otra.masa;
                            this.dx = (this.dx * m1 + otra.dx * m2) / (m1 + m2);
                            this.dy = (this.dy * m1 + otra.dy * m2) / (m1 + m2);

                            this.nombres = this.nombres.concat(otra.nombres);
                            this.masa = m1 + m2;

                            if (this.masa === maxGrupo && this.tiempoLleno === 0) {
                                this.tiempoLleno = Date.now() + Math.random();
                            }

                            this.radioOriginal = RADIO_BASE + (this.masa - 1) * 18;
                            this.radio = this.radioOriginal;

                            if (this.x + this.radio > canvas.width) this.x = canvas.width - this.radio;
                            if (this.x - this.radio < 0) this.x = this.radio;
                            if (this.y + this.radio > canvas.height) this.y = canvas.height - this.radio;
                            if (this.y - this.radio < 0) this.y = this.radio;

                            otra.marcadaParaBorrar = true;
                            this.forzarFusionCon = null; 
                        } else {
                            resolverColision(this, otra);
                        }
                    }
                }

                this.x += this.dx;
                this.y += this.dy;
            }
        }

        // L√≥gica de "Explotar y Repartir Equitativamente"
        function verificarEstancamiento() {
            if (maxGrupo <= 1) return;
            if (bolitas.some(b => b.cooldownFusion > 0)) { temporizadorEstancamiento = 0; return; }

            let incompletas = bolitas.filter(b => b.nombres.length < maxGrupo && !b.marcadaParaBorrar && !b.enZona);
            let completas = bolitas.filter(b => b.nombres.length === maxGrupo && !b.marcadaParaBorrar && !b.enZona); 

            if (incompletas.length === 0) { temporizadorEstancamiento = 0; return; }

            let sumaIncompletas = incompletas.reduce((sum, b) => sum + b.nombres.length, 0);
            let sonRestosDefinitivos = sumaIncompletas < maxGrupo; 

            let puedenFusionarse = false;
            if (!sonRestosDefinitivos) {
                for (let i = 0; i < incompletas.length; i++) {
                    for (let j = i + 1; j < incompletas.length; j++) {
                        if (incompletas[i].nombres.length + incompletas[j].nombres.length <= maxGrupo) {
                            puedenFusionarse = true;
                            break;
                        }
                    }
                    if (puedenFusionarse) break;
                }
            }

            if (sonRestosDefinitivos || !puedenFusionarse) {
                let mayoresAUno = incompletas.filter(b => b.nombres.length > 1);
                if (mayoresAUno.length > 0) {
                    temporizadorEstancamiento++;
                    if (temporizadorEstancamiento > 60) {
                        mayoresAUno.forEach(b => {
                            b.x += (Math.random() - 0.5) * 6;
                            b.y += (Math.random() - 0.5) * 6;
                        });
                    }
                    if (temporizadorEstancamiento > 120) {
                        explotarGruposPequenos(mayoresAUno);
                        temporizadorEstancamiento = 0;
                    }
                    return;
                }

                let disponibles = completas.filter(c => {
                    let targeting = incompletas.filter(inc => inc.forzarFusionCon === c).length;
                    return targeting === 0; 
                });

                disponibles.sort((a, b) => a.tiempoLleno - b.tiempoLleno);

                incompletas.forEach(suelta => {
                    if (suelta.forzarFusionCon) {
                        if (suelta.forzarFusionCon.marcadaParaBorrar || suelta.forzarFusionCon.nombres.length !== maxGrupo) {
                            suelta.forzarFusionCon = null;
                        }
                    }

                    if (!suelta.forzarFusionCon && disponibles.length > 0) {
                        suelta.forzarFusionCon = disponibles.shift();
                    }

                    if (suelta.forzarFusionCon) {
                        let target = suelta.forzarFusionCon;
                        let dx = target.x - suelta.x;
                        let dy = target.y - suelta.y;
                        let dist = Math.hypot(dx, dy);
                        
                        if (dist > 0) {
                            // Aceleraci√≥n de atracci√≥n s√∫per lenta
                            suelta.dx += (dx / dist) * 0.1;
                            suelta.dy += (dy / dist) * 0.1;
                            
                            let speed = Math.hypot(suelta.dx, suelta.dy);
                            // Velocidad m√°xima de atracci√≥n muy reducida
                            if (speed > 2) {
                                suelta.dx = (suelta.dx / speed) * 2;
                                suelta.dy = (suelta.dy / speed) * 2;
                            }
                        }
                    }
                });
                temporizadorEstancamiento = 0;
            } else {
                temporizadorEstancamiento = 0;
            }
        }

        function explotarGruposPequenos(grupos) {
            grupos.forEach(b => {
                b.marcadaParaBorrar = true;
                let cantidad = b.nombres.length;
                let anguloBase = Math.random() * Math.PI * 2;
                for (let i = 0; i < cantidad; i++) {
                    let angulo = anguloBase + (Math.PI * 2 / cantidad) * i;
                    // Velocidad de explosi√≥n m√°s lenta y suave
                    let velocidadExplosion = 3; 
                    let spawnX = b.x + Math.cos(angulo) * 15;
                    let spawnY = b.y + Math.sin(angulo) * 15;

                    let nuevaBolita = new Bolita(spawnX, spawnY, RADIO_BASE, colorAleatorio(), [b.nombres[i]]);
                    nuevaBolita.dx = Math.cos(angulo) * velocidadExplosion;
                    nuevaBolita.dy = Math.sin(angulo) * velocidadExplosion;
                    nuevaBolita.cooldownFusion = 90; 
                    bolitas.push(nuevaBolita);
                }
            });
        }

        // L√≥gica de Rat√≥n: Arrastrar en pausa vs Seleccionar Bolita
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            startX = mouseX;
            startY = mouseY;
            isDragging = false;

            if (isPaused && !bolitaSeleccionada && !bolitaEnRetorno) {
                for (let i = bolitas.length - 1; i >= 0; i--) {
                    const b = bolitas[i];
                    if (Math.hypot(b.x - mouseX, b.y - mouseY) <= b.radio) {
                        bolitaArrastrada = b;
                        b.dx = 0; 
                        b.dy = 0;
                        break;
                    }
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (bolitaArrastrada && isPaused) {
                if (Math.hypot(mouseX - startX, mouseY - startY) > 3) isDragging = true;
                
                if (isDragging) {
                    bolitaArrastrada.x = mouseX;
                    bolitaArrastrada.y = mouseY;
                    if(bolitaArrastrada.x < bolitaArrastrada.radio) bolitaArrastrada.x = bolitaArrastrada.radio;
                    if(bolitaArrastrada.x > canvas.width - bolitaArrastrada.radio) bolitaArrastrada.x = canvas.width - bolitaArrastrada.radio;
                    if(bolitaArrastrada.y < bolitaArrastrada.radio) bolitaArrastrada.y = bolitaArrastrada.radio;
                    if(bolitaArrastrada.y > canvas.height - bolitaArrastrada.radio) bolitaArrastrada.y = canvas.height - bolitaArrastrada.radio;
                }
            } else {
                if (bolitaSeleccionada) { canvas.style.cursor = 'pointer'; return; }
                if (bolitaEnRetorno) { canvas.style.cursor = 'default'; return; }
                
                let hover = false;
                for (let i = 0; i < bolitas.length; i++) {
                    if (Math.hypot(bolitas[i].x - mouseX, bolitas[i].y - mouseY) <= bolitas[i].radio) {
                        hover = true;
                        break;
                    }
                }
                canvas.style.cursor = hover ? (isPaused ? 'grab' : 'pointer') : 'default';
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (bolitaArrastrada) {
                if (!isDragging) {
                    manejarClick(mouseX, mouseY); 
                } else {
                    // Solo permite dejarla si la franja fue activada con el bot√≥n correspondiente
                    if (bolitaArrastrada.x < ZONA_WIDTH && zonaAmarillaHabilitada) {
                        bolitaArrastrada.enZona = 'amarilla';
                    } else if (bolitaArrastrada.x > canvas.width - ZONA_WIDTH && zonaRojaHabilitada) {
                        bolitaArrastrada.enZona = 'roja';
                    } else {
                        bolitaArrastrada.enZona = false;
                    }
                }
                bolitaArrastrada = null;
            } else {
                manejarClick(mouseX, mouseY);
            }
        });

        function manejarClick(mouseX, mouseY) {
            if (bolitaSeleccionada) {
                bolitaEnRetorno = bolitaSeleccionada;
                bolitaSeleccionada = null;
                document.getElementById('btn-abrir-ficha').style.display = 'none';
            } else if (!bolitaEnRetorno) {
                for (let i = bolitas.length - 1; i >= 0; i--) {
                    const b = bolitas[i];
                    if (Math.hypot(b.x - mouseX, b.y - mouseY) <= b.radio) {
                        bolitaSeleccionada = b;
                        b.xOriginal = b.x; 
                        b.yOriginal = b.y;
                        break;
                    }
                }
            }
        }

        function iniciar() {
            ajustarCanvas(); 
            bolitas = [];
            document.getElementById('btn-abrir-ficha').style.display = 'none';
            bolitaSeleccionada = null;
            bolitaEnRetorno = null;

            // Asegurarnos de que no inicien detr√°s de los muros de las franjas
            let limIzq = zonaAmarillaHabilitada ? ZONA_WIDTH : 0;
            let limDer = zonaRojaHabilitada ? ZONA_WIDTH : 0;

            for (let i = 0; i < nombresActuales.length; i++) {
                let x, y, dx, dy;
                let esquina = i % 4; // 0: Arriba-Izq, 1: Arriba-Der, 2: Abajo-Izq, 3: Abajo-Der
                
                // Peque√±o desplazamiento aleatorio para que no salgan exactamente del mismo p√≠xel y se atasquen
                let offsetX = Math.random() * 40;
                let offsetY = Math.random() * 40;

                // Velocidad de disparo inicial muy reducida para un inicio calmado
                if (esquina === 0) { // Esquina Superior Izquierda
                    x = RADIO_BASE + limIzq + offsetX;
                    y = RADIO_BASE + offsetY;
                    dx = Math.random() * 1.5 + 0.5; 
                    dy = Math.random() * 1.5 + 0.5; 
                } else if (esquina === 1) { // Esquina Superior Derecha
                    x = canvas.width - limDer - RADIO_BASE - offsetX;
                    y = RADIO_BASE + offsetY;
                    dx = -(Math.random() * 1.5 + 0.5); 
                    dy = Math.random() * 1.5 + 0.5;    
                } else if (esquina === 2) { // Esquina Inferior Izquierda
                    x = RADIO_BASE + limIzq + offsetX;
                    y = canvas.height - RADIO_BASE - offsetY;
                    dx = Math.random() * 1.5 + 0.5;    
                    dy = -(Math.random() * 1.5 + 0.5); 
                } else { // Esquina Inferior Derecha
                    x = canvas.width - limDer - RADIO_BASE - offsetX;
                    y = canvas.height - RADIO_BASE - offsetY;
                    dx = -(Math.random() * 1.5 + 0.5); 
                    dy = -(Math.random() * 1.5 + 0.5); 
                }

                let nuevaBolita = new Bolita(x, y, RADIO_BASE, colorAleatorio(), [nombresActuales[i]]);
                // Sobrescribimos su velocidad base para aplicar el efecto de disparo
                nuevaBolita.dx = dx;
                nuevaBolita.dy = dy;
                
                bolitas.push(nuevaBolita);
            }
        }

        function animar() {
            requestAnimationFrame(animar);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            
            // Renderizado Zona Izquierda (Amarillo)
            if (zonaAmarillaHabilitada) {
                ctx.fillStyle = 'rgba(255, 235, 59, 0.4)'; 
                ctx.fillRect(0, 0, ZONA_WIDTH, canvas.height);
                ctx.beginPath();
                ctx.moveTo(ZONA_WIDTH, 0);
                ctx.lineTo(ZONA_WIDTH, canvas.height);
                ctx.lineWidth = 4;
                ctx.strokeStyle = 'rgba(212, 160, 0, 0.8)'; 
                ctx.stroke();
            }

            // Renderizado Zona Derecha (Rojo)
            if (zonaRojaHabilitada) {
                ctx.fillStyle = 'rgba(255, 182, 193, 0.4)'; 
                ctx.fillRect(canvas.width - ZONA_WIDTH, 0, ZONA_WIDTH, canvas.height);
                ctx.beginPath();
                ctx.moveTo(canvas.width - ZONA_WIDTH, 0);
                ctx.lineTo(canvas.width - ZONA_WIDTH, canvas.height);
                ctx.lineWidth = 4;
                ctx.strokeStyle = 'rgba(220, 53, 69, 0.8)'; 
                ctx.stroke();
            }
            
            ctx.restore();

            if (bolitaSeleccionada) {
                bolitas.forEach(b => {
                    if (b !== bolitaSeleccionada && !b.marcadaParaBorrar) {
                        ctx.globalAlpha = 0.2;
                        b.dibujar(false);
                        ctx.globalAlpha = 1.0;
                    }
                });

                const b = bolitaSeleccionada;
                
                const targetX = (maxGrupo === 1) ? (zonaAmarillaHabilitada ? ZONA_WIDTH + 140 : 140) : canvas.width / 2;
                const targetY = canvas.height / 2;
                
                b.x += (targetX - b.x) * 0.1;
                b.y += (targetY - b.y) * 0.1;
                b.radio += (130 - b.radio) * 0.1; 
                b.dibujar(true); 

                const btnFicha = document.getElementById('btn-abrir-ficha');
                btnFicha.style.display = 'block';
                btnFicha.style.left = (b.x + b.radio + 20) + 'px';
                btnFicha.style.top = (b.y - 20) + 'px';

            } else if (bolitaEnRetorno) {
                bolitas.forEach(b => {
                    if (b !== bolitaEnRetorno && !b.marcadaParaBorrar) b.dibujar(false);
                });

                const b = bolitaEnRetorno;
                b.x += (b.xOriginal - b.x) * 0.15;
                b.y += (b.yOriginal - b.y) * 0.15;
                b.radio += (b.radioOriginal - b.radio) * 0.15;
                b.dibujar(b.radio > (b.radioOriginal + 30));

                if (Math.abs(b.radio - b.radioOriginal) < 1) {
                    b.x = b.xOriginal;
                    b.y = b.yOriginal;
                    b.radio = b.radioOriginal;
                    bolitaEnRetorno = null; 
                }
            } else {
                if (!isPaused) verificarEstancamiento(); 
                
                bolitas.forEach(bolita => {
                    // Si la bolita est√° en zona, no interact√∫a ni se mueve, solo se dibuja inerte
                    if (bolita.enZona) {
                        bolita.dibujar(false); 
                    } else {
                        bolita.actualizar(bolitas, isPaused);
                    }
                });
                bolitas = bolitas.filter(b => !b.marcadaParaBorrar);
            }
        }

        // Inicializar por defecto con el curso integrado al cargar la p√°gina
        window.onload = () => {
            ajustarCanvas();
            setGrupo(1);
            iniciar();
            animar();
        };

        // -------------------------------------------------------------
        // Temporizadores para Pantalla Principal y Sidebar Desfases
        // -------------------------------------------------------------
        const coloresMetalicos = ['#C0C0C0', '#CD7F32']; 
        const coloresFondo = ['#f4f4f9', '#e6f7ff', '#f0fff0', '#fff0f5', '#ffffe6', '#f5e6ff', '#e6ffee', '#ffebcd', '#f0ffff'];
        const coloresFondoDerecha = ['#fff0f5', '#f0f8ff', '#f5fffa', '#fffacd', '#f0ffff', '#ffe4e1', '#e6e6fa', '#ffebcd', '#fdf5e6']; 

        let indiceMarco = 1; 
        let indiceFondo = 0;
        let indiceFondoCaja = 0;

        setInterval(() => {
            indiceMarco = (indiceMarco + 1) % coloresMetalicos.length;
            document.getElementById('canvas-container').style.borderColor = coloresMetalicos[indiceMarco];
        }, 20000); 

        setInterval(() => {
            indiceFondo = (indiceFondo + 1) % coloresFondo.length;
            document.body.style.backgroundColor = coloresFondo[indiceFondo];

            indiceFondoCaja = (indiceFondoCaja + 1) % coloresFondoDerecha.length;
            document.getElementById('canvas-container').style.backgroundColor = coloresFondoDerecha[indiceFondoCaja];
        }, 15000);

        let indiceMarcoSidebar = 0; 
        let indiceFondoSidebar = 5;
        
        setTimeout(() => {
            setInterval(() => {
                indiceMarcoSidebar = (indiceMarcoSidebar + 1) % coloresMetalicos.length;
                document.getElementById('panel-sidebar').style.borderColor = coloresMetalicos[indiceMarcoSidebar];
            }, 20000);
        }, 10000); 

        setInterval(() => {
            indiceFondoSidebar = (indiceFondoSidebar + 1) % coloresFondo.length;
            document.getElementById('panel-sidebar').style.backgroundColor = coloresFondo[indiceFondoSidebar];
        }, 16000);

    </script>
</body>
</html>