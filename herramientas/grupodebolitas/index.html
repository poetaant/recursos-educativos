<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolitas Interactivas - Cursos</title>
    <!-- Librer√≠a para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            background-color: #f4f4f9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
            transition: background-color 2s ease; 
        }

        /* Panel lateral fijo a la izquierda */
        .sidebar {
            width: 190px; 
            min-width: 190px;
            background-color: #ffe6f2;
            border: 8px ridge #C0C0C0; 
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 10px 15px; 
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: background-color 2s ease, border-color 1s ease; 
        }

        /* Contenedor del lienzo de dibujo */
        #canvas-container {
            flex: 1; 
            border: 16px ridge #CD7F32; 
            border-radius: 20px;
            background-color: #fff0f5;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            transition: border-color 1s ease, background-color 2s ease; 
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        h3 {
            margin: 8px 0 6px 0; 
            color: #00008B; 
            font-size: 14px; 
            text-align: center;
            text-transform: uppercase;
        }
        
        h3:first-child {
            margin-top: 0;
        }

        /* Estilos de la tabla de cursos */
        .tabla-cursos {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px; 
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .tabla-cursos td {
            border: 2px solid #ff99cc;
            padding: 5px 2px; 
            text-align: center;
            font-weight: bold;
            font-size: 12px; 
            color: #00008B; 
            cursor: pointer;
            transition: all 0.2s;
            width: 33.33%; 
        }

        .tabla-cursos td:hover {
            background-color: #ffb3d9;
            color: white;
        }

        .tabla-cursos td.activo {
            background-color: #ff66b2;
            color: white;
            border-color: #ff3399;
        }

        /* Botones de grupos */
        .grupo-botones {
            display: flex;
            flex-direction: column;
            gap: 6px; 
        }

        .grupo-botones button {
            background-color: #fff;
            border: 2px solid #ff99cc;
            color: #00008B; 
            padding: 6px; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px; 
        }

        .grupo-botones button:hover {
            background-color: #ffe6f2;
        }

        .grupo-botones button.activo {
            background-color: #ff66b2;
            color: #fff;
            border-color: #ff3399;
        }

        /* Botones Franjas */
        .btn-zona {
            padding: 6px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            border: 2px solid;
            color: white; 
        }
        #btn-zona-izq { 
            background-color: #28a745; 
            border-color: #1e7e34; 
        }
        #btn-zona-izq:hover { 
            background-color: #218838; 
        }
        #btn-zona-izq.activo { 
            background-color: #1c7430; 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.5); 
            border-color: #145523;
        }
        
        #btn-zona-der { 
            background-color: #dc3545; 
            border-color: #bd2130; 
        }
        #btn-zona-der:hover { 
            background-color: #c82333; 
        }
        #btn-zona-der.activo { 
            background-color: #b02a37; 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.5); 
            border-color: #87202a;
        }

        /* Cuadr√≠cula 2x2 para los botones de grupos */
        .grid-grupos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px; 
        }

        /* Bot√≥n Stop Especial */
        #btn-stop {
            background-color: #ff3333;
            color: white;
            border-color: #cc0000;
            margin-top: 2px; 
            font-size: 13px; 
            padding: 8px;
        }
        #btn-stop:hover { background-color: #ff6666; }
        #btn-stop.activo-stop {
            background-color: #28a745;
            border-color: #1e7e34;
        }
        #btn-stop.activo-stop:hover { background-color: #34ce57; }

        .btn-separador {
            margin-top: 2px;
            border-top: 2px dashed #ffb3d9;
            padding-top: 8px;
        }

        .titulo {
            position: absolute;
            top: 20px;
            left: 20px; 
            color: #ff3399;
            font-weight: bold;
            text-align: left;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            pointer-events: auto; /* Permite hacer clic en botones dentro */
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .titulo-superior {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
        }

        .btn-abrir-informe {
            display: none;
            padding: 6px 12px;
            background: #fff;
            border: 2px solid #ff3399;
            color: #ff3399;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .btn-abrir-informe:hover {
            background: #ff66b2;
            color: white;
        }

        .subtitulo {
            font-size: 15px;
            color: #666;
            display: block;
            font-weight: normal;
            text-shadow: none;
        }

        /* Bot√≥n flotante para la ficha */
        #btn-abrir-ficha {
            display: none;
            position: absolute;
            background: #ff66b2;
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
            transition: transform 0.2s;
        }
        #btn-abrir-ficha:hover { transform: scale(1.05); }

        /* Modal Ficha y Modal Informes*/
        .modal-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 5px solid #ff66b2;
        }

        .modal-content h2 { margin: 0; color: #ff3399; }
        
        #ficha-texto {
            width: 100%;
            height: 150px;
            resize: none;
            padding: 10px;
            border: 2px solid #ffb3d9;
            border-radius: 8px;
            font-family: inherit;
            box-sizing: border-box;
            font-size: 14px;
        }

        .close-btn {
            align-self: flex-end;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            margin-top: -10px;
            margin-bottom: -15px;
        }
        .close-btn:hover { color: #ff3399; }
        
        .btn-modal-accion {
            background-color: #ff66b2;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-modal-accion:hover {
            background-color: #ff3399;
        }

        .btn-informe-opcion {
            background-color: #fff;
            border: 2px solid #ff99cc;
            color: #00008B;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            text-align: left;
        }
        .btn-informe-opcion:hover { background-color: #ffe6f2; color: #ff3399; }

    </style>
</head>
<body>

    <!-- Panel Lateral Izquierdo -->
    <aside class="sidebar" id="panel-sidebar">
        <h3>ELIGE CURSO</h3>
        <table class="tabla-cursos">
            <tr>
                <td onclick="seleccionarCurso('I3A', this)">I3A</td>
                <td onclick="seleccionarCurso('I3B', this)">I3B</td>
                <td onclick="seleccionarCurso('I4', this)">I4</td>
            </tr>
            <tr>
                <td onclick="seleccionarCurso('I5', this)">I5</td>
                <td onclick="seleccionarCurso('1¬∫A', this)">1¬∫A</td>
                <td onclick="seleccionarCurso('1¬∫B', this)">1¬∫B</td>
            </tr>
            <tr>
                <td onclick="seleccionarCurso('2¬∫', this)">2¬∫</td>
                <td onclick="seleccionarCurso('3¬∫A', this)">3¬∫A</td>
                <td onclick="seleccionarCurso('3¬∫B', this)">3¬∫B</td>
            </tr>
            <tr>
                <td onclick="seleccionarCurso('4¬∫A', this)">4¬∫A</td>
                <td onclick="seleccionarCurso('4¬∫B', this)">4¬∫B</td>
                <td onclick="seleccionarCurso('5¬∫A', this)">5¬∫A</td>
            </tr>
            <tr>
                <td onclick="seleccionarCurso('5¬∫B', this)">5¬∫B</td>
                <td onclick="seleccionarCurso('6¬∫A', this)">6¬∫A</td>
                <td onclick="seleccionarCurso('6¬∫B', this)">6¬∫B</td>
            </tr>
        </table>

        <h3>FRANJAS</h3>
        <div class="grid-grupos">
            <button id="btn-zona-izq" class="btn-zona" onclick="toggleZona('izquierda')">L√≠nea Verde</button>
            <button id="btn-zona-der" class="btn-zona" onclick="toggleZona('derecha')">L√≠nea Roja</button>
        </div>
        <div class="btn-separador"></div>

        <h3>FORMA GRUPOS</h3>
        <div class="grupo-botones">
            <div class="grid-grupos">
                <button id="btn-1" class="activo" onclick="setGrupo(1)">De 1</button>
                <button id="btn-2" onclick="setGrupo(2)">De 2</button>
                <button id="btn-3" onclick="setGrupo(3)">De 3</button>
                <button id="btn-4" onclick="setGrupo(4)">De 4</button>
            </div>
            <div class="btn-separador"></div>
            <button onclick="reiniciarBolas()">üîÑ Soltar y Reiniciar</button>
            <button id="btn-stop" onclick="toggleStop()">‚è∏Ô∏è STOP</button>
        </div>
    </aside>

    <!-- √Årea del Canvas Derecho -->
    <main id="canvas-container">
        <!-- T√≠tulos Superiores y Bot√≥n de Informe -->
        <div class="titulo">
            <div class="titulo-superior">
                <span id="nombre-clase-titulo">Selecciona un curso</span>
                <button id="btn-abrir-informe" class="btn-abrir-informe" onclick="abrirModalInforme()">üìÑ Informe</button>
            </div>
            <span class="subtitulo" id="subtitulo-clase">Esperando selecci√≥n...</span>
        </div>

        <!-- Bot√≥n flotante Ficha -->
        <button id="btn-abrir-ficha" onclick="abrirFicha()">üìù Abrir Ficha</button>

        <!-- Modal emergente Ficha -->
        <div id="modal-ficha" class="modal-overlay">
            <div class="modal-content">
                <span class="close-btn" onclick="cerrarFicha()">&times;</span>
                <h2 id="ficha-titulo">Ficha</h2>
                <textarea id="ficha-texto" placeholder="A√±ade notas... Todo se guarda autom√°ticamente."></textarea>
                <button class="btn-modal-accion" onclick="cerrarFicha()">üíæ Guardar y Cerrar</button>
            </div>
        </div>

        <!-- Modal emergente Generar Informe -->
        <div id="modal-informe" class="modal-overlay" style="z-index: 300;">
            <div class="modal-content">
                <span class="close-btn" onclick="cerrarModalInforme()">&times;</span>
                <h2>Generar PDF</h2>
                
                <button class="btn-informe-opcion" onclick="generarInformeCurso()">üìë Informe de Todos los Seleccionados</button>
                
                <button class="btn-informe-opcion" onclick="mostrarSelectAlumnos()">üë§ Informe por Alumno</button>
                <div id="div-select-alumnos" style="display: none; flex-direction: column; gap: 10px; margin-left: 15px;">
                    <select id="select-alumno-informe" style="padding: 8px; border-radius: 5px; border: 1px solid #ff99cc; color:#00008B; font-weight:bold;"></select>
                    <button class="btn-modal-accion" style="background-color: #28a745; padding: 8px;" onclick="generarInformeAlumno()">Generar PDF del Alumno</button>
                </div>
                
                <button class="btn-informe-opcion" onclick="generarInformeGrupos()">üë• Informe de Grupos Manuales</button>
            </div>
        </div>

        <canvas id="miCanvas"></canvas>
    </main>

    <!-- L√ìGICA PRINCIPAL Y GUARDADO EN LA NUBE (FIREBASE PRIVADO) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- TU CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyA1i6ZX7hyg3oKJlTZWURhrNjGmiByDp4U",
          authDomain: "poetaanton-bolitas.firebaseapp.com",
          projectId: "poetaanton-bolitas",
          storageBucket: "poetaanton-bolitas.firebasestorage.app",
          messagingSenderId: "689573097515",
          appId: "1:689573097515:web:9f62768f91748561453a6e",
          measurementId: "G-HX84CE41RW"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let notasAlumnos = {};

        // Iniciar Sesi√≥n An√≥nima para guardar datos
        signInAnonymously(auth).catch((error) => {
            console.error("Error al autenticar con Firebase:", error);
        });
        
        // Escuchar datos en tiempo real cuando la sesi√≥n est√° lista
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // Ruta en tu base de datos: coleccion "notas_clases" -> tu ID -> subcolecci√≥n "fichas"
                const notasRef = collection(db, 'notas_clases', user.uid, 'fichas');
                onSnapshot(notasRef, (snapshot) => {
                    notasAlumnos = {}; // Limpiar antes de recargar
                    snapshot.forEach(documento => {
                        notasAlumnos[documento.id] = documento.data().texto;
                    });
                }, (error) => {
                    console.error("Error cargando notas de la nube:", error);
                });
            }
        });

        // Funci√≥n para subir y guardar notas en la nube
        async function guardarNotaEnNube(nombreGrupo, texto) {
            if (!currentUser || !db) return;
            // Evita caracteres inv√°lidos en el ID del documento
            const safeId = nombreGrupo.replace(/\//g, '-');
            const docRef = doc(db, 'notas_clases', currentUser.uid, 'fichas', safeId);
            try {
                await setDoc(docRef, { texto: texto, updatedAt: new Date().toISOString() });
                console.log("Ficha guardada correctamente en Firebase.");
            } catch (error) {
                console.error("Error guardando nota:", error);
            }
        }

        // --- L√ìGICA PRINCIPAL DE LAS BOLITAS ---

        const canvas = document.getElementById('miCanvas');
        const ctx = canvas.getContext('2d');

        const datosCursos = {
            "I3A": ["Jorge", "Mario", "Maia", "Vega", "Laia", "Candela", "Eiden", "Valeria", "Serigne", "Luna", "Adariannys", "Erik", "Leo", "Julia", "√Ångela"],
            "I3B": ["Ariana", "Rom√°n", "Mateo", "Gonzalo", "Ill√°n", "Eva", "Nahia", "Pelayo", "Ari", "Iago", "Carla", "Nel", "Vera", "Trist√°n", "Chloe", "Eda"],
            "I4": ["Uwais", "Lucas", "Gracia", "India", "Lya", "Erik", "Diego", "Antonio", "Nacho", "Lila", "Chloe", "Eneas", "Manuel", "Mael", "Daniel", "Martina", "Dioma", "Younes", "Alejandro"],
            "I5": ["Yago", "Nur", "Mil√°n", "Martina", "Nela", "Nicholas", "Lia", "Nicol√°s", "Luc√≠a", "Jorge", "Cristina", "Thiago", "Grecia", "Indiana", "Triana", "Alejandro", "Dante", "Carla", "David", "Yassir", "Diego"],
            "1¬∫A": ["Daniela", "Pablo", "Eyla", "Silvia", "Alena", "Kevin", "Amelia", "Mario", "Liv", "Estrella", "Deva", "Olivia"],
            "1¬∫B": ["Hannah", "Elena", "Nacho", "Blanca", "Lisa", "Mouhamed", "Izan", "Lola", "Damian", "Alba", "Noelia", "Verena", "Enzo"],
            "2¬∫": ["Isaac", "Valeria", "Leslie", "Haroun", "Iria", "Enzo", "Lola", "Camila", "Alejandra", "Beatriz", "Luc√≠a", "Leo", "Matteo", "Thiago", "Antonella", "Bruno", "Djei", "Suhaila", "Claudia"],
            "3¬∫A": ["Mat√≠as", "Gala", "Jazm√≠n", "Marti√±o", "Uriel", "Jose", "Dylan", "Dar√≠o", "Liriel", "Celeste", "√Ångel", "Isaac", "Elba", "Carmen", "Einar", "Hugo", "Gabriel"],
            "3¬∫B": ["Elsa", "Abie", "Xel", "Nayara", "Noa", "Jon√°s", "Tymofii", "Yadiel", "Ander", "Adri√°n", "Mario", "√Åfrica", "Izan", "Lucas", "Eloy", "Selena", "Nira", "Rafael"],
            "4¬∫A": ["Deva", "Adriana", "Rub√©n", "Valeria", "Sila", "Emma", "Andrea", "Vega", "Daniela", "Pablo", "Enol", "Nel", "√Ålvaro", "Juan", "Axel", "Diego", "Claudia", "Daniel"],
            "4¬∫B": ["Izan", "Alia", "Chloe", "Celia", "Mael", "Nerea", "Valeria", "Elisa", "Adri√°n", "Leo", "Joaqu√≠n", "Serigne", "Pedro", "Carla", "Kenya", "Quila", "Ainhoa", "Daniel"],
            "5¬∫A": ["Dar√≠o", "Lola", "Daniel", "√Ångel", "Nerea", "Hugo", "Leo", "Ainara", "Pelayo", "Izan", "Genaro", "Iria", "Mark", "Diego", "Carmen", "Dainiel", "Nicolle", "Silvia", "Celia", "Sara", "Nel", "Tarja", "Nel", "Alba"],
            "5¬∫B": ["Elia", "Adriana", "Ariana", "Claudia", "Anas", "Iker", "Iris", "Nicol√°s", "Llu√©", "Leo", "Emma", "Izan", "Noa", "Roberto", "Victoria", "Dmytro", "Cristina", "Mart√≠n", "Luca", "Ager", "Sa√∫l", "Sof√≠a", "Kairo", "Mario"],
            "6¬∫A": ["Valentina", "Noa", "Amaya", "Odeth", "√Ångela", "H√©ctor", "Anxo", "Lukas", "Gabriel", "Mauro", "Nora", "Lola", "Daniel", "Telva", "Noah", "Teo", "Carla", "Elena", "Khadija", "Yoel", "Beltr√°n"],
            "6¬∫B": ["√Ångela", "Laura", "Daniela", "Eire", "Sof√≠a", "Maia", "Rodrigo", "Ant√≥n", "Martina", "Nora", "Luis", "Paul", "Diego", "Xela", "Deva", "Carmen", "Jorge", "Nicol√°s", "Naia", "Gorka", "Nicol√°s", "Javier"]
        };

        let nombresActuales = [];
        let bolitas = [];
        const RADIO_BASE = 40; 
        
        let cursosSeleccionados = []; // Array para guardar m√∫ltiples cursos
        let bolitaSeleccionada = null;
        let bolitaEnRetorno = null;
        let maxGrupo = 1;
        let temporizadorEstancamiento = 0; 
        let spawnTimeout = null; 

        // Zonas Laterales
        const ZONA_WIDTH = 90; 
        let zonaIzquierdaHabilitada = false;
        let zonaDerechaHabilitada = false;

        let isPaused = false;
        let bolitaArrastrada = null;
        let isDragging = false;
        let startX, startY;


        function ajustarCanvas() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        window.addEventListener('resize', () => {
            ajustarCanvas();
            bolitas.forEach(b => {
                if(b.x + b.radio > canvas.width) b.x = canvas.width - b.radio - 5;
                if(b.y + b.radio > canvas.height) b.y = canvas.height - b.radio - 5;
            });
        });

        // -------------------------------------------------------------
        // LOGICA DE INTERFAZ HTML EXPORTADA
        // -------------------------------------------------------------
        window.seleccionarCurso = function(curso, elementoTd) {
            // Alternar la clase activo en el bot√≥n que se ha pulsado
            elementoTd.classList.toggle('activo');

            // A√±adir o quitar el curso de nuestra lista de seleccionados
            if (elementoTd.classList.contains('activo')) {
                cursosSeleccionados.push(curso);
            } else {
                cursosSeleccionados = cursosSeleccionados.filter(c => c !== curso);
            }

            // Actualizar la interfaz y la lista general de nombres
            if (cursosSeleccionados.length === 0) {
                document.getElementById('nombre-clase-titulo').innerText = "Selecciona un curso";
                document.getElementById('subtitulo-clase').innerText = "Esperando selecci√≥n...";
                document.getElementById('btn-abrir-informe').style.display = 'none';
                nombresActuales = [];
            } else {
                document.getElementById('nombre-clase-titulo').innerText = "Cursos: " + cursosSeleccionados.join(', '); 
                document.getElementById('subtitulo-clase').innerText = "Haz clic en una bolita para verla en grande";
                document.getElementById('btn-abrir-informe').style.display = 'block';
                
                // Juntar a todos los alumnos de todos los cursos elegidos
                nombresActuales = [];
                cursosSeleccionados.forEach(c => {
                    nombresActuales = nombresActuales.concat(datosCursos[c]);
                });
            }
            
            window.setGrupo(1); 
            window.reiniciarBolas();
        };

        window.setGrupo = function(num) {
            maxGrupo = num;
            temporizadorEstancamiento = 0; 
            document.querySelectorAll('.grupo-botones button').forEach(btn => btn.classList.remove('activo'));
            document.getElementById('btn-' + num).classList.add('activo');
        };

        window.toggleZona = function(lado) {
            if (lado === 'izquierda') {
                zonaIzquierdaHabilitada = !zonaIzquierdaHabilitada;
                const btn = document.getElementById('btn-zona-izq');
                if (zonaIzquierdaHabilitada) {
                    btn.classList.add('activo');
                    bolitas.forEach(b => {
                        if (!b.enZona && b.x - b.radio < ZONA_WIDTH) {
                            b.x = ZONA_WIDTH + b.radio;
                            b.dx = Math.abs(b.dx);
                        }
                    });
                } else {
                    btn.classList.remove('activo');
                    bolitas.forEach(b => { if (b.enZona === 'izquierda') b.enZona = false; });
                }
            } else {
                zonaDerechaHabilitada = !zonaDerechaHabilitada;
                const btn = document.getElementById('btn-zona-der');
                if (zonaDerechaHabilitada) {
                    btn.classList.add('activo');
                    bolitas.forEach(b => {
                        if (!b.enZona && b.x + b.radio > canvas.width - ZONA_WIDTH) {
                            b.x = canvas.width - ZONA_WIDTH - b.radio;
                            b.dx = -Math.abs(b.dx);
                        }
                    });
                } else {
                    btn.classList.remove('activo');
                    bolitas.forEach(b => { if (b.enZona === 'derecha') b.enZona = false; });
                }
            }
        };

        window.reiniciarBolas = function() {
            window.setGrupo(1);
            
            ajustarCanvas(); 
            bolitas = [];
            document.getElementById('btn-abrir-ficha').style.display = 'none';
            bolitaSeleccionada = null;
            bolitaEnRetorno = null;

            if (spawnTimeout) clearTimeout(spawnTimeout);

            // Si hemos deseleccionado todos los cursos, salimos despu√©s de limpiar la pantalla
            if (nombresActuales.length === 0) return; 

            let limIzq = zonaIzquierdaHabilitada ? ZONA_WIDTH : 0;
            let limDer = zonaDerechaHabilitada ? ZONA_WIDTH : 0;

            let index = 0;

            function spawnNext() {
                if (index >= nombresActuales.length) return;

                let esquina = index % 4; 
                let x, y;
                let marginX = RADIO_BASE + 5;
                let marginY = RADIO_BASE + 5;

                if (esquina === 0) { 
                    x = limIzq + marginX;
                    y = marginY;
                } else if (esquina === 1) { 
                    x = canvas.width - limDer - marginX;
                    y = marginY;
                } else if (esquina === 2) { 
                    x = limIzq + marginX;
                    y = canvas.height - marginY;
                } else { 
                    x = canvas.width - limDer - marginX;
                    y = canvas.height - marginY;
                }

                if (x < limIzq + RADIO_BASE) x = limIzq + RADIO_BASE;
                if (x > canvas.width - limDer - RADIO_BASE) x = canvas.width - limDer - RADIO_BASE;
                if (y < RADIO_BASE) y = RADIO_BASE;
                if (y > canvas.height - RADIO_BASE) y = canvas.height - RADIO_BASE;

                bolitas.push(new Bolita(x, y, RADIO_BASE, colorAleatorio(), [nombresActuales[index]]));
                
                index++;
                spawnTimeout = setTimeout(spawnNext, 250); 
            }

            spawnNext();
        };

        window.toggleStop = function() {
            isPaused = !isPaused;
            const btn = document.getElementById('btn-stop');
            if (isPaused) {
                btn.innerHTML = '‚ñ∂Ô∏è PLAY';
                btn.classList.add('activo-stop');
                document.getElementById('subtitulo-clase').innerText = "Modo pausa: Arrastra las bolitas donde quieras";
            } else {
                btn.innerHTML = '‚è∏Ô∏è STOP';
                btn.classList.remove('activo-stop');
                document.getElementById('subtitulo-clase').innerText = "Haz clic en una bolita para verla en grande";
            }
        };

        // --- SISTEMA INTELIGENTE DE FICHAS ---
        window.abrirFicha = function() {
            if (!bolitaSeleccionada) return;
            const nombreGrupo = bolitaSeleccionada.nombres.join(', ');
            document.getElementById('ficha-titulo').innerText = nombreGrupo;
            
            let textoExistente = notasAlumnos[nombreGrupo] || '';
            
            // Inteligencia de fechas y guiones
            const hoy = new Date();
            const fechaStr = hoy.toLocaleDateString('es-ES'); 
            
            let textoLimpio = textoExistente.trim();
            if (textoLimpio === '') {
                textoExistente = fechaStr + '\n- ';
            } else {
                if (!textoLimpio.includes(fechaStr)) {
                    textoExistente = textoLimpio + '\n\n' + fechaStr + '\n- ';
                } else if (!textoLimpio.endsWith('-')) {
                    textoExistente = textoLimpio + '\n- ';
                } else {
                    textoExistente = textoLimpio + ' ';
                }
            }
            
            document.getElementById('ficha-texto').value = textoExistente;
            
            let esIndividual = bolitaSeleccionada.nombres.length === 1;
            let esManual = bolitaSeleccionada.esManual;
            
            if (esIndividual || esManual) {
                document.getElementById('ficha-texto').placeholder = "A√±ade notas... Todo se guarda permanentemente en la nube.";
            } else {
                document.getElementById('ficha-texto').placeholder = "‚ö†Ô∏è Modo Grupo Autom√°tico: Las notas aqu√≠ se guardar√°n solo durante esta sesi√≥n. (J√∫ntalos arrastr√°ndolos a mano en STOP para guardarlos para siempre).";
            }

            document.getElementById('modal-ficha').style.display = 'flex';
            
            setTimeout(() => {
                const textarea = document.getElementById('ficha-texto');
                textarea.focus();
                textarea.selectionStart = textarea.value.length;
                textarea.selectionEnd = textarea.value.length;
            }, 50);
        };

        window.cerrarFicha = function() {
            const nombreGrupo = document.getElementById('ficha-titulo').innerText;
            const textoActualizado = document.getElementById('ficha-texto').value;
            
            notasAlumnos[nombreGrupo] = textoActualizado;
            
            if (bolitaSeleccionada) {
                let esIndividual = bolitaSeleccionada.nombres.length === 1;
                let esManual = bolitaSeleccionada.esManual;
                
                if (esIndividual || esManual) {
                    guardarNotaEnNube(nombreGrupo, textoActualizado);
                }
            }
            document.getElementById('modal-ficha').style.display = 'none';
        };

        // --- SISTEMA DE GENERACI√ìN DE INFORMES PDF ---
        window.abrirModalInforme = function() {
            document.getElementById('div-select-alumnos').style.display = 'none';
            document.getElementById('modal-informe').style.display = 'flex';
        };

        window.cerrarModalInforme = function() {
            document.getElementById('modal-informe').style.display = 'none';
        };

        window.mostrarSelectAlumnos = function() {
            const select = document.getElementById('select-alumno-informe');
            select.innerHTML = '';
            
            // Ordenar los nombres alfab√©ticamente teniendo en cuenta acentos en espa√±ol
            const nombresOrdenados = [...nombresActuales].sort((a, b) => a.localeCompare(b, 'es'));
            
            nombresOrdenados.forEach(nombre => {
                const opt = document.createElement('option');
                opt.value = nombre;
                opt.innerText = nombre;
                select.appendChild(opt);
            });
            document.getElementById('div-select-alumnos').style.display = 'flex';
        };

        function exportarPDF(nombreArchivo, tituloCabecera, secciones) {
            // Requerimos que la librer√≠a jsPDF haya cargado
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            // T√≠tulo Principal
            doc.setFontSize(18);
            doc.setTextColor(255, 51, 153); // Rosa corporativo
            doc.text(tituloCabecera, 10, y);
            y += 12;

            doc.setFontSize(12);

            secciones.forEach(sec => {
                if (y > 270) { doc.addPage(); y = 20; } // Salto de p√°gina
                
                // Nombre del Alumno o Grupo
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 0, 139); // Azul oscuro
                doc.text(sec.nombre, 10, y);
                y += 7;

                // Contenido de la ficha
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0); // Negro para texto normal
                
                if (!sec.contenido || sec.contenido.trim() === '') {
                    doc.text("Sin registros.", 10, y);
                    y += 10;
                } else {
                    // Divide el texto respetando los saltos de l√≠nea de la caja de texto y ajust√°ndolo al ancho
                    const lineas = doc.splitTextToSize(sec.contenido, 180);
                    lineas.forEach(linea => {
                        if (y > 280) { doc.addPage(); y = 20; }
                        doc.text(linea, 10, y);
                        y += 7;
                    });
                    y += 5;
                }
                y += 5; // Separador entre estudiantes/grupos
            });

            doc.save(nombreArchivo + ".pdf");
            window.cerrarModalInforme();
        }

        window.generarInformeCurso = function() {
            if (cursosSeleccionados.length === 0) return;
            const nombreCursos = cursosSeleccionados.join(', ');
            const secciones = nombresActuales.map(nombre => ({
                nombre: nombre,
                contenido: notasAlumnos[nombre] || ''
            }));
            exportarPDF("Cursos_" + nombreCursos.replace(/, /g, '_'), "Informe de Cursos: " + nombreCursos, secciones);
        };

        window.generarInformeAlumno = function() {
            const alumno = document.getElementById('select-alumno-informe').value;
            if (!alumno) return;
            const nombreCursos = cursosSeleccionados.join(', ');
            exportarPDF(alumno, "Informe Alumno: " + alumno + " (Clases: " + nombreCursos + ")", [{
                nombre: alumno,
                contenido: notasAlumnos[alumno] || ''
            }]);
        };

        window.generarInformeGrupos = function() {
            if (cursosSeleccionados.length === 0) return;
            const nombreCursos = cursosSeleccionados.join(', ');
            // Busca en la BBDD los grupos que tengan comas (varios miembros) y que pertenezcan a los cursos activos
            let gruposDelCurso = Object.keys(notasAlumnos).filter(k => k.includes(',') && k.split(', ').some(n => nombresActuales.includes(n)));
            
            let secciones = gruposDelCurso.map(g => ({
                nombre: g,
                contenido: notasAlumnos[g] || ''
            }));

            if (secciones.length === 0) {
                secciones = [{ nombre: "Aviso", contenido: "No hay notas guardadas para grupos manuales en estos cursos." }];
            }
            
            exportarPDF("Grupos_" + nombreCursos.replace(/, /g, '_'), "Informe Grupos Manuales: " + nombreCursos, secciones);
        };


        // --- F√çSICAS DE LAS BOLITAS ---

        function colorAleatorio() {
            const colores = [
                '#FF5733', '#33FF57', '#3357FF', '#F033FF', '#33FFF0',
                '#FFD133', '#FF3380', '#80FF33', '#3380FF', '#FF8C33',
                '#4A235A', '#117A65', '#D4AC0D', '#BA4A00', '#2E86C1'
            ];
            return colores[Math.floor(Math.random() * colores.length)];
        }

        function rotar(velocidad, angulo) {
            return {
                x: velocidad.x * Math.cos(angulo) - velocidad.y * Math.sin(angulo),
                y: velocidad.x * Math.sin(angulo) + velocidad.y * Math.cos(angulo)
            };
        }

        function resolverColision(bolita, otraBolita) {
            const diffXVelocidad = bolita.dx - otraBolita.dx;
            const diffYVelocidad = bolita.dy - otraBolita.dy;
            const xDist = otraBolita.x - bolita.x;
            const yDist = otraBolita.y - bolita.y;

            if (diffXVelocidad * xDist + diffYVelocidad * yDist >= 0) {
                const angulo = -Math.atan2(otraBolita.y - bolita.y, otraBolita.x - bolita.x);
                const m1 = bolita.masa;
                const m2 = otraBolita.masa;
                const u1 = rotar({ x: bolita.dx, y: bolita.dy }, angulo);
                const u2 = rotar({ x: otraBolita.dx, y: otraBolita.dy }, angulo);

                const v1 = { x: (u1.x * (m1 - m2) + 2 * m2 * u2.x) / (m1 + m2), y: u1.y };
                const v2 = { x: (u2.x * (m2 - m1) + 2 * m1 * u1.x) / (m1 + m2), y: u2.y };

                const vFinal1 = rotar(v1, -angulo);
                const vFinal2 = rotar(v2, -angulo);

                bolita.dx = vFinal1.x;
                bolita.dy = vFinal1.y;
                otraBolita.dx = vFinal2.x;
                otraBolita.dy = vFinal2.y;
            }
        }

        class Bolita {
            constructor(x, y, radio, color, nombresArray) {
                this.x = x;
                this.y = y;
                this.radioOriginal = radio; 
                this.radio = radio;
                this.color = color;
                
                this.nombres = nombresArray; 
                this.masa = nombresArray.length; 

                this.xOriginal = x; 
                this.yOriginal = y;
                this.marcadaParaBorrar = false;
                this.cooldownFusion = 0; 
                this.tiempoLleno = 0; 
                this.forzarFusionCon = null; 
                this.enZona = false; 
                this.esManual = false; 
                
                let velX = (Math.random() * 2.0) + 1.0; 
                let velY = (Math.random() * 2.0) + 1.0;
                
                if (x > canvas.width / 2) velX = -velX;
                if (y > canvas.height / 2) velY = -velY;

                this.dx = velX;
                this.dy = velY;
            }

            dibujar(esGrande = false) {
                ctx.beginPath();
                ctx.arc(this.x + (esGrande ? 8 : 3), this.y + (esGrande ? 8 : 3), this.radio, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radio, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.lineWidth = esGrande ? 6 : 3;
                ctx.strokeStyle = '#fff';
                ctx.stroke();
                ctx.closePath();

                ctx.fillStyle = '#00008B'; 
                const fontSize = esGrande ? 38 : 16;
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.lineWidth = esGrande ? 4 : 2;
                ctx.strokeStyle = '#ffffff'; 
                
                let lineSpacing = esGrande ? (fontSize + 10) : 18;
                let startY = this.y - ((this.nombres.length - 1) * lineSpacing) / 2;
                
                this.nombres.forEach((nombre, idx) => {
                    let yPos = startY + idx * lineSpacing;
                    ctx.strokeText(nombre, this.x, yPos);
                    ctx.fillText(nombre, this.x, yPos);
                });
            }

            actualizar(bolitasArray, pausado) {
                if (this.marcadaParaBorrar) return;
                
                if (this.cooldownFusion > 0 && !pausado) this.cooldownFusion--; 

                this.dibujar();

                if (pausado) return; 

                let limiteIzquierdo = zonaIzquierdaHabilitada ? ZONA_WIDTH : 0;
                let limiteDerecho = zonaDerechaHabilitada ? canvas.width - ZONA_WIDTH : canvas.width;

                if (this.x - this.radio <= limiteIzquierdo) {
                    this.dx = Math.abs(this.dx);
                    this.x = limiteIzquierdo + this.radio;
                } else if (this.x + this.radio >= limiteDerecho) {
                    this.dx = -Math.abs(this.dx);
                    this.x = limiteDerecho - this.radio;
                }
                
                if (this.y + this.radio >= canvas.height || this.y - this.radio <= 0) {
                    this.dy = -this.dy;
                    if (this.y + this.radio >= canvas.height) this.y = canvas.height - this.radio;
                    if (this.y - this.radio <= 0) this.y = this.radio;
                }

                for (let i = 0; i < bolitasArray.length; i++) {
                    let otra = bolitasArray[i];
                    if (this === otra || otra.marcadaParaBorrar || otra.enZona) continue;

                    const dist = Math.hypot(this.x - otra.x, this.y - otra.y);
                    
                    if (dist - (this.radio + otra.radio) < 0) {
                        
                        let puedeFusionarseNormal = maxGrupo > 1 && (this.nombres.length + otra.nombres.length) <= maxGrupo;
                        let esFusionForzada = (this.forzarFusionCon === otra) || (otra.forzarFusionCon === this);

                        if (this.forzarFusionCon && !esFusionForzada) puedeFusionarseNormal = false;
                        if (otra.forzarFusionCon && !esFusionForzada) puedeFusionarseNormal = false;

                        if ((puedeFusionarseNormal || esFusionForzada) && 
                            this.cooldownFusion === 0 && 
                            otra.cooldownFusion === 0) {
                            
                            const m1 = this.masa;
                            const m2 = otra.masa;
                            this.dx = (this.dx * m1 + otra.dx * m2) / (m1 + m2);
                            this.dy = (this.dy * m1 + otra.dy * m2) / (m1 + m2);

                            this.nombres = this.nombres.concat(otra.nombres);
                            this.masa = m1 + m2;
                            this.esManual = false; 

                            if (this.masa === maxGrupo && this.tiempoLleno === 0) {
                                this.tiempoLleno = Date.now() + Math.random();
                            }

                            this.radioOriginal = RADIO_BASE + (this.masa - 1) * 18;
                            this.radio = this.radioOriginal;

                            if (this.x + this.radio > canvas.width) this.x = canvas.width - this.radio;
                            if (this.x - this.radio < 0) this.x = this.radio;
                            if (this.y + this.radio > canvas.height) this.y = canvas.height - this.radio;
                            if (this.y - this.radio < 0) this.y = this.radio;

                            otra.marcadaParaBorrar = true;
                            this.forzarFusionCon = null; 
                        } else {
                            resolverColision(this, otra);
                        }
                    }
                }

                this.x += this.dx;
                this.y += this.dy;
            }
        }

        function verificarEstancamiento() {
            if (maxGrupo <= 1) return;
            if (bolitas.some(b => b.cooldownFusion > 0)) { temporizadorEstancamiento = 0; return; }

            let incompletas = bolitas.filter(b => b.nombres.length < maxGrupo && !b.marcadaParaBorrar && !b.enZona);
            let completas = bolitas.filter(b => b.nombres.length === maxGrupo && !b.marcadaParaBorrar && !b.enZona); 

            if (incompletas.length === 0) { temporizadorEstancamiento = 0; return; }

            let sumaIncompletas = incompletas.reduce((sum, b) => sum + b.nombres.length, 0);
            let sonRestosDefinitivos = sumaIncompletas < maxGrupo; 

            let puedenFusionarse = false;
            if (!sonRestosDefinitivos) {
                for (let i = 0; i < incompletas.length; i++) {
                    for (let j = i + 1; j < incompletas.length; j++) {
                        if (incompletas[i].nombres.length + incompletas[j].nombres.length <= maxGrupo) {
                            puedenFusionarse = true;
                            break;
                        }
                    }
                    if (puedenFusionarse) break;
                }
            }

            if (sonRestosDefinitivos || !puedenFusionarse) {
                let mayoresAUno = incompletas.filter(b => b.nombres.length > 1);
                if (mayoresAUno.length > 0) {
                    temporizadorEstancamiento++;
                    if (temporizadorEstancamiento > 60) {
                        mayoresAUno.forEach(b => {
                            b.x += (Math.random() - 0.5) * 6;
                            b.y += (Math.random() - 0.5) * 6;
                        });
                    }
                    if (temporizadorEstancamiento > 120) {
                        explotarGruposPequenos(mayoresAUno);
                        temporizadorEstancamiento = 0;
                    }
                    return;
                }

                let disponibles = completas.filter(c => {
                    let targeting = incompletas.filter(inc => inc.forzarFusionCon === c).length;
                    return targeting === 0; 
                });

                disponibles.sort((a, b) => a.tiempoLleno - b.tiempoLleno);

                incompletas.forEach(suelta => {
                    if (suelta.forzarFusionCon) {
                        if (suelta.forzarFusionCon.marcadaParaBorrar || suelta.forzarFusionCon.nombres.length !== maxGrupo) {
                            suelta.forzarFusionCon = null;
                        }
                    }

                    if (!suelta.forzarFusionCon && disponibles.length > 0) {
                        suelta.forzarFusionCon = disponibles.shift();
                    }

                    if (suelta.forzarFusionCon) {
                        let target = suelta.forzarFusionCon;
                        let dx = target.x - suelta.x;
                        let dy = target.y - suelta.y;
                        let dist = Math.hypot(dx, dy);
                        
                        if (dist > 0) {
                            suelta.dx += (dx / dist) * 0.4;
                            suelta.dy += (dy / dist) * 0.4;
                            
                            let speed = Math.hypot(suelta.dx, suelta.dy);
                            if (speed > 5) {
                                suelta.dx = (suelta.dx / speed) * 5;
                                suelta.dy = (suelta.dy / speed) * 5;
                            }
                        }
                    }
                });
                temporizadorEstancamiento = 0;
            } else {
                temporizadorEstancamiento = 0;
            }
        }

        function explotarGruposPequenos(grupos) {
            grupos.forEach(b => {
                b.marcadaParaBorrar = true;
                let cantidad = b.nombres.length;
                let anguloBase = Math.random() * Math.PI * 2;
                for (let i = 0; i < cantidad; i++) {
                    let angulo = anguloBase + (Math.PI * 2 / cantidad) * i;
                    let velocidadExplosion = 8; 
                    let spawnX = b.x + Math.cos(angulo) * 15;
                    let spawnY = b.y + Math.sin(angulo) * 15;

                    let nuevaBolita = new Bolita(spawnX, spawnY, RADIO_BASE, colorAleatorio(), [b.nombres[i]]);
                    nuevaBolita.dx = Math.cos(angulo) * velocidadExplosion;
                    nuevaBolita.dy = Math.sin(angulo) * velocidadExplosion;
                    nuevaBolita.cooldownFusion = 90; 
                    bolitas.push(nuevaBolita);
                }
            });
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            startX = mouseX;
            startY = mouseY;
            isDragging = false;

            if (isPaused && !bolitaSeleccionada && !bolitaEnRetorno) {
                for (let i = bolitas.length - 1; i >= 0; i--) {
                    const b = bolitas[i];
                    if (Math.hypot(b.x - mouseX, b.y - mouseY) <= b.radio) {
                        bolitaArrastrada = b;
                        b.dx = 0; 
                        b.dy = 0;
                        break;
                    }
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (bolitaArrastrada && isPaused) {
                if (Math.hypot(mouseX - startX, mouseY - startY) > 3) isDragging = true;
                
                if (isDragging) {
                    bolitaArrastrada.x = mouseX;
                    bolitaArrastrada.y = mouseY;
                    if(bolitaArrastrada.x < bolitaArrastrada.radio) bolitaArrastrada.x = bolitaArrastrada.radio;
                    if(bolitaArrastrada.x > canvas.width - bolitaArrastrada.radio) bolitaArrastrada.x = canvas.width - bolitaArrastrada.radio;
                    if(bolitaArrastrada.y < bolitaArrastrada.radio) bolitaArrastrada.y = bolitaArrastrada.radio;
                    if(bolitaArrastrada.y > canvas.height - bolitaArrastrada.radio) bolitaArrastrada.y = canvas.height - bolitaArrastrada.radio;
                }
            } else {
                if (bolitaSeleccionada) { canvas.style.cursor = 'pointer'; return; }
                if (bolitaEnRetorno) { canvas.style.cursor = 'default'; return; }
                
                let hover = false;
                for (let i = 0; i < bolitas.length; i++) {
                    if (Math.hypot(bolitas[i].x - mouseX, bolitas[i].y - mouseY) <= bolitas[i].radio) {
                        hover = true;
                        break;
                    }
                }
                canvas.style.cursor = hover ? (isPaused ? 'grab' : 'pointer') : 'default';
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (bolitaArrastrada) {
                if (!isDragging) {
                    manejarClick(mouseX, mouseY); 
                } else {
                    let fusionManual = false;
                    for (let i = 0; i < bolitas.length; i++) {
                        let otra = bolitas[i];
                        if (otra !== bolitaArrastrada && !otra.marcadaParaBorrar) {
                            const dist = Math.hypot(bolitaArrastrada.x - otra.x, bolitaArrastrada.y - otra.y);
                            if (dist < (bolitaArrastrada.radio + otra.radio)) {
                                otra.nombres = otra.nombres.concat(bolitaArrastrada.nombres);
                                otra.masa = otra.nombres.length;
                                otra.radioOriginal = RADIO_BASE + (otra.masa - 1) * 18;
                                otra.radio = otra.radioOriginal;
                                otra.esManual = true; 
                                bolitaArrastrada.marcadaParaBorrar = true;
                                fusionManual = true;
                                break;
                            }
                        }
                    }

                    if (!fusionManual) {
                        if (bolitaArrastrada.x < ZONA_WIDTH && zonaIzquierdaHabilitada) {
                            bolitaArrastrada.enZona = 'izquierda';
                        } else if (bolitaArrastrada.x > canvas.width - ZONA_WIDTH && zonaDerechaHabilitada) {
                            bolitaArrastrada.enZona = 'derecha';
                        } else {
                            bolitaArrastrada.enZona = false;
                        }
                    }
                }
                bolitaArrastrada = null;
            } else {
                manejarClick(mouseX, mouseY);
            }
        });

        function manejarClick(mouseX, mouseY) {
            if (bolitaSeleccionada) {
                bolitaEnRetorno = bolitaSeleccionada;
                bolitaSeleccionada = null;
                document.getElementById('btn-abrir-ficha').style.display = 'none';
            } else if (!bolitaEnRetorno) {
                for (let i = bolitas.length - 1; i >= 0; i--) {
                    const b = bolitas[i];
                    if (Math.hypot(b.x - mouseX, b.y - mouseY) <= b.radio) {
                        bolitaSeleccionada = b;
                        b.xOriginal = b.x; 
                        b.yOriginal = b.y;
                        break;
                    }
                }
            }
        }

        function animar() {
            requestAnimationFrame(animar);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            
            if (zonaIzquierdaHabilitada) {
                ctx.fillStyle = 'rgba(144, 238, 144, 0.4)'; 
                ctx.fillRect(0, 0, ZONA_WIDTH, canvas.height);
                ctx.beginPath();
                ctx.moveTo(ZONA_WIDTH, 0);
                ctx.lineTo(ZONA_WIDTH, canvas.height);
                ctx.lineWidth = 4;
                ctx.strokeStyle = 'rgba(40, 167, 69, 0.8)'; 
                ctx.stroke();
            }

            if (zonaDerechaHabilitada) {
                ctx.fillStyle = 'rgba(255, 182, 193, 0.4)'; 
                ctx.fillRect(canvas.width - ZONA_WIDTH, 0, ZONA_WIDTH, canvas.height);
                ctx.beginPath();
                ctx.moveTo(canvas.width - ZONA_WIDTH, 0);
                ctx.lineTo(canvas.width - ZONA_WIDTH, canvas.height);
                ctx.lineWidth = 4;
                ctx.strokeStyle = 'rgba(220, 53, 69, 0.8)'; 
                ctx.stroke();
            }
            
            ctx.restore();

            if (bolitaSeleccionada) {
                bolitas.forEach(b => {
                    if (b !== bolitaSeleccionada && !b.marcadaParaBorrar) {
                        ctx.globalAlpha = 0.2;
                        b.dibujar(false);
                        ctx.globalAlpha = 1.0;
                    }
                });

                const b = bolitaSeleccionada;
                
                const targetX = (maxGrupo === 1) ? (zonaIzquierdaHabilitada ? ZONA_WIDTH + 140 : 140) : canvas.width / 2;
                
                b.x += (targetX - b.x) * 0.1;
                b.y += (canvas.height / 2 - b.y) * 0.1;
                b.radio += (130 - b.radio) * 0.1; 
                b.dibujar(true); 

                const btnFicha = document.getElementById('btn-abrir-ficha');
                btnFicha.style.display = 'block';
                btnFicha.style.left = (b.x + b.radio + 20) + 'px';
                btnFicha.style.top = (b.y - 20) + 'px';

            } else if (bolitaEnRetorno) {
                bolitas.forEach(b => {
                    if (b !== bolitaEnRetorno && !b.marcadaParaBorrar) b.dibujar(false);
                });

                const b = bolitaEnRetorno;
                b.x += (b.xOriginal - b.x) * 0.15;
                b.y += (b.yOriginal - b.y) * 0.15;
                b.radio += (b.radioOriginal - b.radio) * 0.15;
                b.dibujar(b.radio > (b.radioOriginal + 30));

                if (Math.abs(b.radio - b.radioOriginal) < 1) {
                    b.x = b.xOriginal;
                    b.y = b.yOriginal;
                    b.radio = b.radioOriginal;
                    bolitaEnRetorno = null; 
                }
            } else {
                if (!isPaused) verificarEstancamiento(); 
                
                bolitas.forEach(bolita => {
                    if (bolita.enZona) {
                        bolita.dibujar(false); 
                    } else {
                        bolita.actualizar(bolitas, isPaused);
                    }
                });
                bolitas = bolitas.filter(b => !b.marcadaParaBorrar);
            }
        }

        ajustarCanvas();
        animar();

        const coloresMetalicos = ['#C0C0C0', '#CD7F32']; 
        const coloresFondo = ['#f4f4f9', '#e6f7ff', '#f0fff0', '#fff0f5', '#ffffe6', '#f5e6ff', '#e6ffee', '#ffebcd', '#f0ffff'];
        const coloresFondoDerecha = ['#fff0f5', '#f0f8ff', '#f5fffa', '#fffacd', '#f0ffff', '#ffe4e1', '#e6e6fa', '#ffebcd', '#fdf5e6']; 

        let indiceMarco = 1; 
        let indiceFondo = 0;
        let indiceFondoCaja = 0;

        setInterval(() => {
            indiceMarco = (indiceMarco + 1) % coloresMetalicos.length;
            document.getElementById('canvas-container').style.borderColor = coloresMetalicos[indiceMarco];
        }, 20000); 

        setInterval(() => {
            indiceFondo = (indiceFondo + 1) % coloresFondo.length;
            document.body.style.backgroundColor = coloresFondo[indiceFondo];

            indiceFondoCaja = (indiceFondoCaja + 1) % coloresFondoDerecha.length;
            document.getElementById('canvas-container').style.backgroundColor = coloresFondoDerecha[indiceFondoCaja];
        }, 15000);

        let indiceMarcoSidebar = 0; 
        let indiceFondoSidebar = 5;
        
        setTimeout(() => {
            setInterval(() => {
                indiceMarcoSidebar = (indiceMarcoSidebar + 1) % coloresMetalicos.length;
                document.getElementById('panel-sidebar').style.borderColor = coloresMetalicos[indiceMarcoSidebar];
            }, 20000);
        }, 10000); 

        setInterval(() => {
            indiceFondoSidebar = (indiceFondoSidebar + 1) % coloresFondo.length;
            document.getElementById('panel-sidebar').style.backgroundColor = coloresFondo[indiceFondoSidebar];
        }, 16000);

    </script>
</body>
</html>