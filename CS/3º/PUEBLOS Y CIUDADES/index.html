<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUEBLOS Y CIUDADES</title>
    <!-- Cargamos Three.js desde un servidor r√°pido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Importamos una fuente bonita y legible */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        /* ESTILOS GENERALES */
        body { 
            margin: 0; 
            overflow: hidden; /* Evita barras de desplazamiento */
            font-family: 'Roboto', sans-serif; 
            background-color: #e0f7fa; 
        }
        
        /* CAPA DE INTERFAZ (UI) - Se coloca encima del juego 3D */
        #ui-layer {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Deja pasar los clics al juego si no hay bot√≥n */
            display: flex; 
            flex-direction: column;
        }

        /* PANEL SUPERIOR (HUD) */
        #top-hud {
            display: flex; 
            justify-content: space-between; 
            padding: 20px;
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #000;
        }
        
        #info-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px 25px; 
            border-radius: 15px; 
            border: 3px solid #333;
            text-align: right;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            pointer-events: auto;
        }
        
        #score-display { 
            font-size: 1.8rem; 
            color: #2196F3; 
            margin-bottom: 5px; 
            font-weight: 900;
        }
        
        #player-display { 
            font-size: 1.2rem; 
            color: #333; 
        }

        /* CAJA DE PREGUNTAS (Esquina Inferior Izquierda) */
        #question-box {
            position: absolute; 
            bottom: 30px; 
            left: 30px;
            width: 450px; 
            max-width: 85%;
            background: rgba(255, 255, 255, 0.98);
            padding: 25px; 
            border-radius: 20px;
            border: 5px solid #2196F3;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            pointer-events: auto; /* Permite hacer clic en las opciones */
            color: black; /* IMPORTANTE: Letras negras */
            transition: transform 0.2s;
            z-index: 20;
        }
        
        /* Animaci√≥n de temblor para fallos */
        #question-box.shake { animation: shake 0.5s; border-color: #D32F2F; }
        
        #q-indicator { 
            font-size: 0.9rem; 
            color: #666; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        
        #q-text { 
            font-size: 1.4rem; 
            margin-bottom: 20px; 
            font-weight: 800; 
            color: black; 
            line-height: 1.4; 
        }
        
        .option-btn {
            display: block; 
            width: 100%; 
            padding: 12px 15px; 
            margin-bottom: 10px;
            background: #f5f5f5; 
            color: black; 
            border: 2px solid #ccc;
            border-radius: 10px; 
            cursor: pointer; 
            text-align: left;
            font-size: 1.1rem; 
            font-weight: 600; 
            transition: all 0.2s;
            font-family: 'Roboto', sans-serif;
        }
        
        .option-btn:hover { 
            background: #e3f2fd; 
            border-color: #2196F3; 
            transform: translateX(5px); 
        }
        
        /* Input para preguntas de texto */
        #text-input { 
            width: 90%; 
            padding: 12px; 
            font-size: 1.2rem; 
            border: 3px solid #333; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            display: none; 
            font-family: inherit;
        }
        
        #submit-text { 
            background: #FF9800; 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: none; 
            font-weight: bold; 
            font-size: 1.1rem;
            box-shadow: 0 4px #F57C00;
        }
        
        #submit-text:active { 
            transform: translateY(2px); 
            box-shadow: 0 2px #F57C00; 
        }

        /* MENSAJE DE ERROR (Toast) */
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(211, 47, 47, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 60;
            animation: fadeInOut 1.5s ease-in-out;
            text-align: center;
        }

        /* NUBE DE REFUERZO */
        #cloud-overlay {
            position: absolute; 
            top: 5%; 
            left: 50%; 
            transform: translateX(-50%);
            width: 600px; 
            padding: 40px;
            background: white;
            border-radius: 50px; /* Forma redondeada simple */
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border: 6px solid #B3E5FC;
            z-index: 50; 
            text-align: center;
            pointer-events: auto;
        }
        
        /* Decoraci√≥n de la nube con pseudoelementos */
        #cloud-overlay::before, #cloud-overlay::after {
            content: ''; position: absolute; background: white; border-radius: 50%; z-index: -1;
        }
        #cloud-overlay::before { width: 120px; height: 120px; top: -40px; left: 80px; }
        #cloud-overlay::after { width: 160px; height: 160px; top: -60px; right: 80px; }

        .cloud-title { 
            font-size: 1.8rem; 
            color: #D32F2F; 
            font-weight: 900; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
        }
        
        .cloud-subtitle { 
            font-size: 1.2rem; 
            color: #555; 
            margin-bottom: 20px; 
            font-style: italic; 
        }
        
        .reinforce-text { 
            font-size: 1.4rem; 
            color: black; 
            font-weight: bold; 
            margin-bottom: 20px; 
        }

        /* BOCADILLO DE C√ìMIC */
        #comic-bubble {
            position: absolute; 
            top: 25%; 
            right: 5%;
            background: white; 
            padding: 25px; 
            border-radius: 30px;
            border: 4px solid #000; 
            max-width: 300px;
            font-weight: bold; 
            font-size: 1.2rem; 
            color: black;
            display: none; 
            z-index: 40;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.8);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #comic-bubble::after {
            content: ''; 
            position: absolute; 
            bottom: -20px; 
            right: 40px;
            border-width: 20px 20px 0; 
            border-style: solid; 
            border-color: #000 transparent;
        }

        /* PANTALLAS (INICIO / FIN) */
        .full-screen {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%); 
            z-index: 100;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            pointer-events: auto;
            text-align: center;
        }
        
        .avatar-row { 
            display: flex; 
            gap: 20px; 
            margin: 30px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        
        .avatar { 
            font-size: 4rem; 
            cursor: pointer; 
            padding: 15px; 
            border: 4px solid transparent; 
            border-radius: 50%; 
            background: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, border-color 0.2s; 
        }
        
        .avatar:hover { transform: scale(1.1); }
        .avatar.selected { background: #E8F5E9; border-color: #4CAF50; transform: scale(1.1); }
        
        input.name-in { 
            font-size: 1.5rem; 
            padding: 15px; 
            border: 3px solid #ccc; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            width: 300px; 
            text-align: center; 
        }
        
        button.start-btn { 
            font-size: 1.8rem; 
            padding: 15px 50px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 8px #1565C0; 
            transition: transform 0.1s;
        }
        
        button.start-btn:active { transform: translateY(4px); box-shadow: 0 4px #1565C0; }

        /* ANIMACIONES CSS */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -40%); } 10% { opacity: 1; transform: translate(-50%, -50%); } 90% { opacity: 1; } 100% { opacity: 0; } }

    </style>
</head>
<body>

    <!-- Contenedor 3D -->
    <div id="canvas-container"></div>

    <!-- UI -->
    <div id="ui-layer">
        
        <!-- Marcador Arriba Derecha -->
        <div id="top-hud">
            <div style="flex:1"></div>
            <div id="info-panel">
                <div id="score-display">Puntos: <span id="score-val">0.00</span></div>
                <div id="player-display">
                    <span id="p-avatar-display"></span> <span id="p-name-display"></span>
                </div>
            </div>
        </div>

        <!-- Bocadillo de Feedback (Acierto) -->
        <div id="comic-bubble">¬°Bien! El objetivo es no tener fichas rojas.</div>

        <!-- Mensaje de Error (Fallo) -->
        <div id="error-message">‚ùå ¬°Respuesta Incorrecta! ‚ùå<br><span style="font-size: 1.2rem;">-0.05 Puntos</span></div>

        <!-- Nube de Refuerzo (Solo visible en errores consecutivos) -->
        <div id="cloud-overlay">
            <div class="cloud-title">¬°¬°¬°¬°Ohhh tienes que estudiar m√°s!!!</div>
            <div class="cloud-subtitle">Vamos a las preguntas de repaso (Penalizaci√≥n: -0.05)</div>
            <div id="cloud-content">
                <!-- Las preguntas de refuerzo se inyectan aqu√≠ -->
            </div>
        </div>

        <!-- Caja de Preguntas (Abajo Izquierda) -->
        <div id="question-box">
            <div id="q-indicator">Pregunta 1/50</div>
            <div id="q-text">Cargando pregunta...</div>
            <div id="options-container"></div>
            <input type="text" id="text-input" placeholder="Escribe tu respuesta aqu√≠...">
            <button id="submit-text" onclick="game.submitText()">RESPONDER</button>
        </div>
    </div>

    <!-- PANTALLA DE INICIO -->
    <div id="start-screen" class="full-screen">
        <h1 style="color: #1565C0; font-size: 4rem; text-shadow: 2px 2px 0px #90CAF9; text-align: center; margin-bottom: 20px;">PUEBLOS Y CIUDADES</h1>
        <p style="font-size: 1.4rem; color: #555; max-width: 600px;">
            Responde correctamente para construir la pir√°mide de colores. 
            ¬°Evita los bloques rojos y la nube de refuerzo!
        </p>
        
        <p style="font-size: 1.2rem; font-weight: bold; margin-top: 20px;">Elige tu Avatar:</p>
        <div class="avatar-row">
            <div class="avatar selected" onclick="selectAvatar(this, 'üßë‚Äçüéì')">üßë‚Äçüéì</div>
            <div class="avatar" onclick="selectAvatar(this, 'üë©‚Äçüî¨')">üë©‚Äçüî¨</div>
            <div class="avatar" onclick="selectAvatar(this, 'ü§ñ')">ü§ñ</div>
            <div class="avatar" onclick="selectAvatar(this, 'ü¶ä')">ü¶ä</div>
            <div class="avatar" onclick="selectAvatar(this, 'ü¶Å')">ü¶Å</div>
        </div>

        <input type="text" id="player-name-input" class="name-in" placeholder="Tu nombre" maxlength="12">
        <button class="start-btn" onclick="startGame()">¬°JUGAR!</button>
    </div>

    <!-- PANTALLA FINAL -->
    <div id="end-screen" class="full-screen" style="display: none; background: rgba(0,0,0,0.92); color: white;">
        <h1 style="font-size: 3rem; margin-bottom: 10px;">¬°Juego Terminado!</h1>
        <h2 id="end-message" style="font-size: 2.5rem; margin: 20px; color: #FFEB3B; text-shadow: 2px 2px 0 #000;"></h2>
        
        <div style="background: rgba(255,255,255,0.15); padding: 40px; border-radius: 30px; width: 400px; border: 2px solid rgba(255,255,255,0.3);">
            <p style="font-size: 1.5rem; margin: 10px 0;">‚úÖ Aciertos: <span id="end-correct" style="color: #69F0AE; font-weight: bold;">0</span></p>
            <p style="font-size: 1.5rem; margin: 10px 0;">‚ùå Fallos: <span id="end-wrong" style="color: #FF5252; font-weight: bold;">0</span></p>
            <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
            <p style="font-size: 2rem; margin: 10px 0;">‚≠ê NOTA: <span id="end-score" style="color: #FFD740; font-weight: bold;">0.0</span></p>
        </div>
        
        <button class="start-btn" onclick="location.reload()" style="margin-top: 40px; background: #00C853; box-shadow: 0 8px #00600F;">Jugar de nuevo</button>
    </div>

<script>
    // --- BASE DE DATOS DE PREGUNTAS (50 Preguntas ordenadas por dificultad) ---
    // Cada 5 preguntas es tipo "text"
    const QUESTIONS = [
        // F√ÅCILES (1-15)
        { q: "¬øC√≥mo se llama la persona que manda en el ayuntamiento?", a: ["Alcalde", "Polic√≠a", "Juez", "Bombero"], c: 0 },
        { q: "¬øQu√© documento tiene la lista de todos los vecinos?", a: ["El mapa", "El padr√≥n", "El libro", "La carta"], c: 1 },
        { q: "¬øDe qu√© color es la se√±al que nos OBLIGA a hacer algo?", a: ["Roja", "Amarilla", "Azul", "Verde"], c: 2 },
        { q: "¬øQu√© servicio municipal apaga los incendios?", a: ["Limpieza", "Bomberos", "Jardiner√≠a", "Cultura"], c: 1 },
        { q: "ESCRIBE: ¬øC√≥mo se llaman las personas que viven en un mismo municipio?", type: "text", ans: ["vecinos", "habitantes", "ciudadanos"] }, 
        
        { q: "¬øQu√© forma tienen las se√±ales de PELIGRO?", a: ["Redonda", "Triangular", "Cuadrada", "Rectangular"], c: 1 },
        { q: "¬øCu√°l es la zona m√°s antigua de la ciudad?", a: ["Ensanche", "Periferia", "Casco antiguo", "Pol√≠gono"], c: 2 },
        { q: "¬øQu√© documento necesitamos para viajar fuera de Europa?", a: ["Pasaporte", "Carnet de conducir", "Ticket de metro", "Foto"], c: 0 },
        { q: "¬øQu√© indican las se√±ales redondas con borde rojo?", a: ["Peligro", "Informaci√≥n", "Prohibici√≥n", "Obligaci√≥n"], c: 2 },
        { q: "ESCRIBE: ¬øQu√© veh√≠culo con sirena y luces azules lleva enfermos al hospital?", type: "text", ans: ["ambulancia"] }, 

        { q: "¬øQui√©n ayuda al alcalde a gobernar?", a: ["Los concejales", "Los profesores", "Los m√©dicos", "Los panaderos"], c: 0 },
        { q: "¬øQu√© servicio recoge la basura?", a: ["Alumbrado", "Limpieza", "Polic√≠a", "Transporte"], c: 1 },
        { q: "¬øQu√© significan las siglas ODS?", a: ["Organizaci√≥n de Salud", "Objetivos de Desarrollo Sostenible", "Orden de Seguridad", "Oficina Simple"], c: 1 },
        { q: "¬øEn qu√© zona de la ciudad hay f√°bricas?", a: ["Centro", "Ensanche", "Pol√≠gono industrial", "Parque"], c: 2 },
        { q: "ESCRIBE: ¬øDe qu√© color es la luz del sem√°foro que nos obliga a PARAR?", type: "text", ans: ["roja", "rojo"] }, 

        // MEDIAS (16-35)
        { q: "¬øQu√© es el Padr√≥n Municipal?", a: ["Un plano", "Registro de habitantes", "Una se√±al", "Un edificio"], c: 1 },
        { q: "¬øCada cu√°ntos a√±os votamos en las elecciones municipales?", a: ["2 a√±os", "4 a√±os", "6 a√±os", "10 a√±os"], c: 1 },
        { q: "¬øQu√© ODS busca ciudades sostenibles?", a: ["ODS 1", "ODS 5", "ODS 11", "ODS 16"], c: 2 },
        { q: "¬øQui√©n preside el Pleno Municipal?", a: ["El concejal joven", "El Alcalde", "El Secretario", "El Juez"], c: 1 },
        { q: "ESCRIBE: ¬øC√≥mo se llama la reuni√≥n del alcalde con los concejales?", type: "text", ans: ["pleno", "pleno municipal"] }, 
        
        { q: "¬øC√≥mo son las calles del 'Ensanche'?", a: ["Estrechas y curvas", "Antiguas", "Anchas y rectas", "De tierra"], c: 2 },
        { q: "¬øQu√© servicio organiza las fiestas?", a: ["Cultura y ocio", "Urbanismo", "Sanidad", "Seguridad"], c: 0 },
        { q: "¬øSi vas en bici, qu√© se√±al debes respetar?", a: ["Solo las de bici", "Todas las se√±ales", "Ninguna", "Solo los sem√°foros"], c: 1 },
        { q: "¬øQui√©n gobierna una provincia?", a: ["El Ayuntamiento", "La Diputaci√≥n", "El Parlamento", "La Comunidad"], c: 1 },
        { q: "ESCRIBE: ¬øQu√© debemos ponernos en la cabeza al ir en bicicleta?", type: "text", ans: ["casco"] }, 
        
        { q: "¬øQu√© es la contaminaci√≥n ac√∫stica?", a: ["Humo", "Mucho ruido", "Basura", "Poca luz"], c: 1 },
        { q: "¬øQu√© ODS promueve la paz y la justicia?", a: ["ODS 16", "ODS 3", "ODS 1", "ODS 10"], c: 0 },
        { q: "¬øQu√© hace la polic√≠a local?", a: ["Apagar fuegos", "Regular tr√°fico", "Cuidar jardines", "Construir casas"], c: 1 },
        { q: "¬øQu√© es una pedan√≠a?", a: ["Una gran ciudad", "Un pueblo agregado a otro", "Una se√±al", "Un parque"], c: 1 },
        { q: "ESCRIBE: ¬øQu√© pagamos al ayuntamiento para tener servicios?", type: "text", ans: ["impuestos", "tasas"] }, 
        
        { q: "¬øQu√© significa la luz √°mbar fija?", a: ["Pasar r√°pido", "Detenerse si es seguro", "Prioridad", "Girar"], c: 1 },
        { q: "¬øCu√°l es el √≥rgano de gobierno del municipio?", a: ["Comisar√≠a", "Ayuntamiento", "Hospital", "Colegio"], c: 1 },
        { q: "¬øQu√© transporte contamina menos?", a: ["Coche", "Autob√∫s / Metro", "Cami√≥n", "Moto"], c: 1 },
        { q: "¬øQu√© es el √©xodo rural?", a: ["Ir de vacaciones", "Irse del campo a la ciudad", "Volver al campo", "Comprar una casa"], c: 1 },
        { q: "ESCRIBE: ¬øQu√© n√∫mero de tel√©fono es para emergencias?", type: "text", ans: ["112"] }, 

        // DIF√çCILES (36-50)
        { q: "¬øQu√© zona suele tener un plano irregular?", a: ["Ensanche", "Periferia", "Casco hist√≥rico", "Pol√≠gono"], c: 2 },
        { q: "¬øQu√© ODS busca la igualdad de g√©nero?", a: ["ODS 5", "ODS 1", "ODS 10", "ODS 12"], c: 0 },
        { q: "¬øQui√©n elige al alcalde?", a: ["El rey", "Los concejales", "Los vecinos directos", "El presidente"], c: 1 },
        { q: "¬øQu√© forma tienen las se√±ales de informaci√≥n?", a: ["Triangular", "Redonda", "Cuadrada", "Octogonal"], c: 2 },
        { q: "ESCRIBE: ¬øCu√°l es la ley m√°s importante de Espa√±a?", type: "text", ans: ["constitucion", "constituci√≥n"] }, 
        
        { q: "¬øQui√©n arregla las farolas?", a: ["Limpieza", "Alumbrado", "Jardiner√≠a", "Sanidad"], c: 1 },
        { q: "¬øQu√© es un barrio residencial?", a: ["Zona de f√°bricas", "Zona comercial", "Zona de viviendas", "Centro"], c: 2 },
        { q: "¬øSi mides menos de 135cm en coche?", a: ["Ir delante", "Silla homologada", "Nada", "Cintur√≥n normal"], c: 1 },
        { q: "¬øQu√© Concejal√≠a cuida los parques?", a: ["Urbanismo", "Medio Ambiente", "Hacienda", "Cultura"], c: 1 },
        { q: "ESCRIBE: ¬øC√≥mo se llama el dibujo de una ciudad vista desde arriba?", type: "text", ans: ["plano", "mapa"] }, 
        
        { q: "¬øQu√© es participar como ciudadano?", a: ["No hacer nada", "Dar opini√≥n y votar", "Quedarse en casa", "Ensuciar"], c: 1 },
        { q: "¬øQu√© indica un STOP?", a: ["Ceder paso", "Detenerse siempre", "Peligro", "Prohibido"], c: 1 },
        { q: "¬øQui√©n gestiona el agua potable?", a: ["Abastecimiento", "Alumbrado", "Limpieza", "Seguridad"], c: 0 },
        { q: "¬øQu√© ODS lucha contra la pobreza?", a: ["ODS 1", "ODS 13", "ODS 7", "ODS 4"], c: 0 },
        { q: "ESCRIBE: ¬øQu√© parte del mapa explica los s√≠mbolos?", type: "text", ans: ["leyenda"] } 
    ];

    // Preguntas de Repaso (Simples y directas)
    const REINFORCE_POOL = [
        { q: "¬øEl sem√°foro rojo es parar o pasar?", a: ["Parar", "Pasar"], c: 0 },
        { q: "¬øEl alcalde trabaja en el colegio?", a: ["S√≠", "No"], c: 1 },
        { q: "¬øLos bomberos apagan fuegos?", a: ["S√≠", "No"], c: 0 },
        { q: "¬øEl casco antiguo es la parte nueva?", a: ["S√≠", "No"], c: 1 },
        { q: "¬øDebemos tirar basura al suelo?", a: ["S√≠", "No"], c: 1 },
        { q: "¬øLa acera es para los peatones?", a: ["S√≠", "No"], c: 0 },
        { q: "¬øUn pueblo es muy grande?", a: ["S√≠", "No"], c: 1 }
    ];

    // --- CONFIGURACI√ìN DEL JUEGO ---
    const COLORS = [0xFFEB3B, 0x03A9F4, 0x8BC34A, 0x9C27B0, 0xFF9800]; // Amarillo, Azul, Verde, Violeta, Naranja
    const RED_COLOR = 0xD32F2F; // Rojo para errores
    const PENALTY = 0.05; // Penalizaci√≥n por fallo (MODIFICADO)
    
    // Estado del Juego
    let gameState = {
        score: 0,
        correct: 0,
        wrong: 0,
        qIndex: 0, // √çndice de pregunta actual
        consecutiveWrong: 0,
        inReinforcement: false,
        reinforceCount: 0,
        pointsSinceBonus: 0,
        playerName: "",
        avatar: "üßë‚Äçüéì",
        blocks: [], // Array de bloques 3D
        active: false
    };

    let scene, camera, renderer, activeBlock;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- INICIO ---
    function selectAvatar(el, icon) {
        document.querySelectorAll('.avatar').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        gameState.avatar = icon;
    }

    function startGame() {
        const name = document.getElementById('player-name-input').value.trim();
        if(!name) { alert("¬°Por favor, escribe tu nombre!"); return; }
        
        gameState.playerName = name;
        document.getElementById('p-name-display').innerText = name;
        document.getElementById('p-avatar-display').innerText = gameState.avatar;
        
        document.getElementById('start-screen').style.display = 'none';
        
        init3D();
        gameState.active = true;
        nextQuestion();
    }

    // --- 3D THREE.JS ---
    function init3D() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0f7fa); // Azul cielo claro

        // C√°mara isom√©trica ajustada para ver la pir√°mide crecer sin tapar la UI
        const aspect = window.innerWidth / window.innerHeight;
        const d = 18;
        camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
        camera.position.set(20, 20, 20); // Vista isom√©trica est√°ndar
        camera.lookAt(0, 5, 0); // Mirar un poco hacia arriba para centrar la pir√°mide

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Iluminaci√≥n
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(10, 20, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Suelo (Grid)
        const grid = new THREE.GridHelper(40, 40, 0xaaaaaa, 0xffffff);
        grid.position.y = -0.5;
        scene.add(grid);

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // Animaci√≥n de ca√≠da de bloque
        if(activeBlock) {
            if(activeBlock.position.y > activeBlock.targetY) {
                activeBlock.position.y -= 0.4; // Velocidad de ca√≠da
            } else {
                activeBlock.position.y = activeBlock.targetY;
                // Peque√±o rebote visual al aterrizar
                if(!activeBlock.landed) {
                    activeBlock.landed = true;
                    playTone(100, 'square'); // Sonido golpe seco
                }
            }
        }
        
        renderer.render(scene, camera);
    }

    // --- L√ìGICA DE JUEGO ---

    function nextQuestion() {
        if(gameState.qIndex >= QUESTIONS.length && !gameState.inReinforcement) {
            finishGame();
            return;
        }

        const qBox = document.getElementById('question-box');
        const cloud = document.getElementById('cloud-overlay');
        const qIndicator = document.getElementById('q-indicator');
        const qText = document.getElementById('q-text');
        const optCont = document.getElementById('options-container');
        const txtInput = document.getElementById('text-input');
        const btnSubmit = document.getElementById('submit-text');

        // Reset UI
        optCont.innerHTML = '';
        txtInput.value = '';
        txtInput.style.display = 'none';
        btnSubmit.style.display = 'none';
        qBox.classList.remove('shake');

        // MODO REFUERZO (NUBE)
        if(gameState.inReinforcement) {
            cloud.style.display = 'flex';
            qBox.style.display = 'none'; // Ocultar caja normal
            
            const rIndex = Math.floor(Math.random() * REINFORCE_POOL.length);
            const qData = REINFORCE_POOL[rIndex];
            
            const cloudContent = document.getElementById('cloud-content');
            cloudContent.innerHTML = `<div class="reinforce-text">${qData.q}</div>`;
            
            qData.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.style.border = "2px solid #B3E5FC"; // Estilo nube
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(i === qData.c, true);
                cloudContent.appendChild(btn);
            });
            return;
        }

        // MODO NORMAL
        cloud.style.display = 'none';
        qBox.style.display = 'block';
        
        const qData = QUESTIONS[gameState.qIndex];
        qIndicator.innerText = `PREGUNTA ${gameState.qIndex + 1} / 50`;
        qText.innerText = qData.q;

        if(qData.type === 'text') {
            txtInput.style.display = 'block';
            btnSubmit.style.display = 'block';
            txtInput.focus();
        } else {
            qData.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(i === qData.c, false);
                optCont.appendChild(btn);
            });
        }
    }

    // Funci√≥n para el bot√≥n HTML de texto
    window.game = {
        submitText: function() {
            const val = document.getElementById('text-input').value.trim().toLowerCase();
            const qData = QUESTIONS[gameState.qIndex];
            
            // Comprueba si alguna de las respuestas v√°lidas est√° contenida en lo escrito
            const isCorrect = qData.ans.some(a => val.includes(a));
            handleAnswer(isCorrect, false);
        }
    };

    function showErrorMessage() {
        const errorMsg = document.getElementById('error-message');
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 1500); // Muestra el mensaje por 1.5 segundos
    }

    function handleAnswer(isCorrect, isReinforceMode) {
        if(isReinforceMode) {
            // L√≥gica dentro de la Nube
            if(!isCorrect) {
                playTone(150, 'sawtooth');
                gameState.wrong++; // Penaliza tambi√©n
                showErrorMessage(); // Mensaje visual de fallo
                updateScore();
            } else {
                playTone(500, 'sine');
            }
            
            gameState.reinforceCount++;
            if(gameState.reinforceCount >= 3) {
                // Fin del refuerzo
                gameState.inReinforcement = false;
                gameState.consecutiveWrong = 0;
                document.getElementById('cloud-overlay').style.display = 'none';
                nextQuestion();
            } else {
                // Siguiente de refuerzo
                setTimeout(nextQuestion, 500); 
            }
            return;
        }

        // L√≥gica Normal
        if(isCorrect) {
            playTone(600, 'sine'); // Sonido Acierto
            gameState.correct++;
            gameState.pointsSinceBonus++;
            gameState.consecutiveWrong = 0;
            
            spawnBlock(true); // Bloque de Color
            checkBonus();
        } else {
            playTone(100, 'sawtooth'); // Sonido Fallo
            document.getElementById('question-box').classList.add('shake');
            gameState.wrong++;
            gameState.consecutiveWrong++;
            
            showErrorMessage(); // Mensaje visual de fallo
            spawnBlock(false); // Bloque ROJO
            
            if(gameState.consecutiveWrong >= 4) {
                // Activar Refuerzo
                setTimeout(startReinforcement, 1000);
                // No avanzamos qIndex todav√≠a para no saltar la pregunta actual (aunque ya se cont√≥ el fallo)
                updateScore();
                gameState.qIndex++; 
                return;
            }
        }

        updateScore();
        gameState.qIndex++;
        setTimeout(nextQuestion, 1500); // Esperar a que caiga el bloque
    }

    function startReinforcement() {
        gameState.inReinforcement = true;
        gameState.reinforceCount = 0;
        playTone(300, 'square'); // Sonido alerta
        nextQuestion(); // Esto mostrar√° la nube
    }

    function updateScore() {
        // F√≥rmula: (Aciertos * 0.2) - (Fallos * 0.05) - NUEVA F√ìRMULA
        gameState.score = (gameState.correct * 0.2) - (gameState.wrong * PENALTY);
        document.getElementById('score-val').innerText = gameState.score.toFixed(2);
    }

    function checkBonus() {
        // Cada 2 puntos (o aciertos en este caso simplificado para fluidez visual)
        if(gameState.pointsSinceBonus >= 2) {
            gameState.pointsSinceBonus = 0;
            
            // Sonido especial
            playTone(800, 'triangle');
            setTimeout(() => playTone(1200, 'triangle'), 100);

            // Bocadillo
            const bubble = document.getElementById('comic-bubble');
            bubble.style.display = 'block';
            setTimeout(() => bubble.style.display = 'none', 3000);

            // Brillo en el bloque (Emissive flash)
            if(activeBlock) {
                activeBlock.material.emissive.setHex(0xFFFFFF); // Brillo blanco
                setTimeout(() => {
                    activeBlock.material.emissive.setHex(0x000000); // Apagar brillo
                }, 500);
            }
        }
    }

    // --- L√ìGICA PIR√ÅMIDE (Tetris Stack) ---
    function spawnBlock(isCorrect) {
        // Estructura de pir√°mide centrada
        // Base 6x6 = 36 bloques (Capa 0)
        // Capa 1 = 4x4 = 16 bloques
        // Capa 2 = 2x2 = 4 bloques...
        
        const idx = gameState.blocks.length;
        let x, y, z;
        
        if (idx < 36) { // Base
            const row = Math.floor(idx / 6);
            const col = idx % 6;
            x = (col - 2.5) * 1.5;
            z = (row - 2.5) * 1.5;
            y = 0;
        } else if (idx < 36 + 16) { // 2¬∫ Piso
            const relIdx = idx - 36;
            const row = Math.floor(relIdx / 4);
            const col = relIdx % 4;
            x = (col - 1.5) * 1.5;
            z = (row - 1.5) * 1.5;
            y = 1.5;
        } else { // Punta
            // Si el jugador es muy bueno y supera los bloques previstos, apilamos arriba
            x = 0; z = 0;
            y = 3 + ((idx - 52) * 1.5);
        }

        const geometry = new THREE.BoxGeometry(1.4, 1.4, 1.4);
        // Si es correcto: Color aleatorio (menos rojo). Si falla: ROJO.
        const colorHex = isCorrect ? COLORS[Math.floor(Math.random()*COLORS.length)] : RED_COLOR;
        
        const material = new THREE.MeshLambertMaterial({ color: colorHex });
        const mesh = new THREE.Mesh(geometry, material);
        
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        
        // Empezar muy arriba para caer
        mesh.position.set(x, 40, z);
        mesh.targetY = y;
        mesh.landed = false;

        scene.add(mesh);
        gameState.blocks.push(mesh);
        activeBlock = mesh;
    }

    // --- SONIDO ---
    function playTone(freq, type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }

    // --- FIN DEL JUEGO ---
    function finishGame() {
        document.getElementById('ui-layer').style.display = 'none';
        const endScreen = document.getElementById('end-screen');
        endScreen.style.display = 'flex';

        updateScore();
        const finalScore = gameState.score;
        
        document.getElementById('end-correct').innerText = gameState.correct;
        document.getElementById('end-wrong').innerText = gameState.wrong;
        document.getElementById('end-score').innerText = finalScore.toFixed(2);

        const msgEl = document.getElementById('end-message');
        if(finalScore > 8) {
            msgEl.innerText = "¬°Bien estudiado! üèÜ";
            msgEl.style.color = "#00E676";
        } else if(finalScore >= 6) {
            msgEl.innerText = "Hay que estudiar m√°s üìö";
            msgEl.style.color = "#FF9100";
        } else {
            msgEl.innerText = "As√≠ no vas bien ¬°ESTUDIA! ‚ö†Ô∏è";
            msgEl.style.color = "#FF1744";
        }
    }

</script>
</body>
</html>